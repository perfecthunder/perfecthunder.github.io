<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö¶ Simulasi Lalu Lintas Indonesia - Simpang 4 Tengah Kota</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap");

        :root {
          --primary: #4f46e5;
          --secondary: #06b6d4;
          --success: #10b981;
          --warning: #f59e0b;
          --danger: #ef4444;
          --dark: rgba(15, 15, 35, 0.95);
          --glass: rgba(255, 255, 255, 0.1);
          --text-primary: #ffffff;
          --text-secondary: rgba(255, 255, 255, 0.8);
          --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: "Inter", sans-serif;
          background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
          overflow: hidden;
          color: var(--text-primary);
          user-select: none;
          touch-action: manipulation;
        }

        #gameContainer {
          width: 100vw;
          height: 100vh;
          position: relative;
        }

        #renderer {
          display: block;
          cursor: grab;
          touch-action: none;
        }

        #renderer:active {
          cursor: grabbing;
        }

        /* Modern Vehicle Selection Modal */
        .vehicle-selection-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.95);
          backdrop-filter: blur(20px);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 5000;
          animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }

        .vehicle-selection-content {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
          backdrop-filter: blur(30px);
          padding: 50px;
          border-radius: 32px;
          max-width: 1000px;
          width: 90%;
          color: #1f2937;
          box-shadow: var(--shadow);
          border: 1px solid rgba(255, 255, 255, 0.3);
          text-align: center;
          animation: slideUp 0.6s ease;
        }

        @keyframes slideUp {
          from { transform: translateY(50px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }

        .vehicle-selection-content h1 {
          font-size: 2.5rem;
          font-weight: 900;
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          margin-bottom: 10px;
        }

        .vehicle-selection-content p {
          font-size: 1.1rem;
          color: #6b7280;
          margin-bottom: 40px;
          line-height: 1.6;
        }

        .vehicle-options {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 30px;
          margin: 40px 0;
        }

        .vehicle-option {
          padding: 40px 30px;
          background: linear-gradient(135deg, var(--primary), #6366f1);
          color: white;
          border: none;
          border-radius: 24px;
          cursor: pointer;
          font-size: 18px;
          font-weight: 700;
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          text-align: center;
          position: relative;
          overflow: hidden;
          box-shadow: 0 10px 30px rgba(79, 70, 229, 0.3);
        }

        .vehicle-option::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
          transition: left 0.5s;
        }

        .vehicle-option:hover::before {
          left: 100%;
        }

        .vehicle-option:hover {
          transform: translateY(-8px) scale(1.02);
          box-shadow: 0 20px 50px rgba(79, 70, 229, 0.4);
        }

        .vehicle-option.motorcycle {
          background: linear-gradient(135deg, var(--warning), #d97706);
          box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
        }

        .vehicle-option.motorcycle:hover {
          box-shadow: 0 20px 50px rgba(245, 158, 11, 0.4);
        }

        .vehicle-option.pedestrian {
          background: linear-gradient(135deg, var(--success), #059669);
          box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .vehicle-option.pedestrian:hover {
          box-shadow: 0 20px 50px rgba(16, 185, 129, 0.4);
        }

        .vehicle-image {
          width: 100px;
          height: 80px;
          margin: 0 auto 20px;
          background: rgba(255, 255, 255, 0.2);
          border-radius: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 48px;
          backdrop-filter: blur(10px);
        }

        .feature-list {
          background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
          padding: 30px;
          border-radius: 20px;
          margin-top: 30px;
          text-align: left;
        }

        .feature-list h3 {
          color: #1f2937;
          margin-bottom: 20px;
          font-size: 1.3rem;
          font-weight: 700;
        }

        .feature-list ul {
          list-style: none;
          color: #374151;
          line-height: 1.8;
        }

        .feature-list li {
          margin-bottom: 8px;
          padding-left: 25px;
          position: relative;
        }

        .feature-list li::before {
          content: '‚úÖ';
          position: absolute;
          left: 0;
        }

        /* Vehicle Inspection Modal */
        .vehicle-inspection-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.95);
          backdrop-filter: blur(20px);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 6000;
          animation: fadeIn 0.5s ease;
        }

        .vehicle-inspection-content {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
          backdrop-filter: blur(30px);
          padding: 40px;
          border-radius: 32px;
          max-width: 900px;
          width: 90%;
          color: #1f2937;
          box-shadow: var(--shadow);
          border: 1px solid rgba(255, 255, 255, 0.3);
          text-align: center;
          animation: slideUp 0.6s ease;
          max-height: 90vh;
          overflow-y: auto;
        }

        .inspection-header {
          margin-bottom: 30px;
        }

        .inspection-header h2 {
          font-size: 2rem;
          font-weight: 900;
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          margin-bottom: 10px;
        }

        .vehicle-3d-viewer {
          width: 100%;
          height: 400px;
          background: linear-gradient(135deg, #1a1a2e, #16213e);
          border-radius: 20px;
          margin: 20px 0;
          position: relative;
          overflow: hidden;
          border: 2px solid var(--glass);
        }

        .vehicle-3d-controls {
          position: absolute;
          bottom: 15px;
          left: 50%;
          transform: translateX(-50%);
          display: flex;
          gap: 10px;
          z-index: 10;
        }

        .rotate-btn {
          padding: 8px 12px;
          background: rgba(255, 255, 255, 0.2);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 0.8rem;
          font-weight: 600;
          transition: all 0.3s ease;
          backdrop-filter: blur(10px);
        }

        .rotate-btn:hover {
          background: rgba(255, 255, 255, 0.3);
          transform: translateY(-2px);
        }

        .vehicle-specs {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin: 30px 0;
        }

        .spec-card {
          background: linear-gradient(135deg, #f8fafc, #e2e8f0);
          padding: 20px;
          border-radius: 16px;
          text-align: left;
          border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .spec-card h4 {
          color: var(--primary);
          font-size: 1.1rem;
          font-weight: 700;
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .spec-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 0;
          border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .spec-item:last-child {
          border-bottom: none;
        }

        .spec-label {
          font-weight: 500;
          color: #4b5563;
        }

        .spec-value {
          font-weight: 700;
          color: #1f2937;
        }

        .inspection-actions {
          display: flex;
          gap: 15px;
          justify-content: center;
          margin-top: 30px;
        }

        .action-btn {
          padding: 12px 24px;
          border: none;
          border-radius: 12px;
          cursor: pointer;
          font-size: 1rem;
          font-weight: 600;
          transition: all 0.3s ease;
          min-width: 120px;
        }

        .action-btn.primary {
          background: linear-gradient(135deg, var(--primary), #6366f1);
          color: white;
        }

        .action-btn.secondary {
          background: linear-gradient(135deg, #6b7280, #4b5563);
          color: white;
        }

        .action-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        /* Modern UI Overlay */
        .ui-overlay {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 1000;
        }

        .header {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 60px;
          background: var(--dark);
          backdrop-filter: blur(20px);
          border-bottom: 1px solid var(--glass);
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0 20px;
          pointer-events: auto;
          box-shadow: var(--shadow);
        }

        .header h1 {
          font-size: 1.2rem;
          font-weight: 800;
          background: linear-gradient(45deg, var(--primary), var(--secondary));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .score-system {
          display: flex;
          gap: 15px;
          align-items: center;
        }

        .score-item {
          font-size: 0.9rem;
          font-weight: 600;
          padding: 8px 12px;
          background: var(--glass);
          border-radius: 12px;
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 6px;
        }

        .score-item:hover {
          background: rgba(255, 255, 255, 0.15);
          transform: translateY(-2px);
        }

        .panel {
          position: absolute;
          background: var(--dark);
          backdrop-filter: blur(20px);
          border: 1px solid var(--glass);
          border-radius: 16px;
          padding: 20px;
          pointer-events: auto;
          box-shadow: var(--shadow);
          transition: all 0.3s ease;
        }

        .info-panel {
          top: 70px;
          left: 20px;
          max-width: 280px;
          font-size: 0.9rem;
        }

        .controls-panel {
          bottom: 20px;
          right: 20px;
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
          max-width: 200px;
        }

        .inspector-panel {
          top: 70px;
          right: 20px;
          max-width: 300px;
          font-size: 0.9rem;
          display: none;
        }

        .panel h3 {
          font-size: 1.1rem;
          font-weight: 700;
          margin-bottom: 15px;
          color: var(--secondary);
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .control-btn {
          padding: 10px 15px;
          background: linear-gradient(135deg, var(--primary), #6366f1);
          color: white;
          border: none;
          border-radius: 12px;
          cursor: pointer;
          font-size: 0.85rem;
          font-weight: 600;
          transition: all 0.3s ease;
          border: 1px solid rgba(255, 255, 255, 0.1);
          white-space: nowrap;
        }

        .control-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
          background: linear-gradient(135deg, #5b21b6, var(--primary));
        }

        .control-btn:active {
          transform: scale(0.95);
        }

        .control-btn.active {
          background: linear-gradient(135deg, var(--success), #059669);
        }

        .speed-indicator {
          position: absolute;
          width: 100px;
          height: 100px;
          bottom: 20px;
          right: 240px;
          background: var(--dark);
          backdrop-filter: blur(20px);
          border: 2px solid var(--glass);
          border-radius: 50%;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          pointer-events: auto;
          box-shadow: var(--shadow);
          overflow: hidden;
        }

        .speed-content {
          position: relative;
          z-index: 2;
          text-align: center;
        }

        .speed-value {
          font-size: 1.8rem;
          font-weight: 900;
          background: linear-gradient(45deg, var(--secondary), var(--primary));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          line-height: 1;
        }

        .speed-unit {
          font-size: 0.7rem;
          opacity: 0.8;
          font-weight: 600;
          margin-top: 4px;
        }

        .speed-limit {
          font-size: 0.6rem;
          margin-top: 6px;
          color: var(--warning);
          font-weight: 500;
        }

        .violation-notification {
          position: fixed;
          top: 70px;
          right: 20px;
          max-width: 320px;
          padding: 15px 20px;
          border-radius: 12px;
          font-weight: 600;
          opacity: 0;
          transform: translateX(100%);
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          z-index: 2000;
          pointer-events: none;
          box-shadow: var(--shadow);
          font-size: 0.9rem;
        }

        .violation-notification.show {
          opacity: 1;
          transform: translateX(0);
        }

        .violation-notification.minor {
          background: linear-gradient(135deg, var(--warning), #d97706);
          color: white;
        }

        .violation-notification.major {
          background: linear-gradient(135deg, var(--danger), #dc2626);
          color: white;
        }

        .violation-notification.success {
          background: linear-gradient(135deg, var(--success), #059669);
          color: white;
        }

        .violation-notification.info {
          background: linear-gradient(135deg, var(--secondary), #0891b2);
          color: white;
        }

        .loading {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          color: white;
          font-size: 1.5rem;
          text-align: center;
          font-weight: 600;
        }

        .loading-spinner {
          width: 60px;
          height: 60px;
          border: 4px solid rgba(255, 255, 255, 0.3);
          border-top: 4px solid var(--secondary);
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin: 30px auto;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        .error-message {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(239, 68, 68, 0.95);
          color: white;
          padding: 30px;
          border-radius: 16px;
          text-align: center;
          font-weight: 600;
          max-width: 500px;
          box-shadow: var(--shadow);
        }

        .vehicle-info {
          margin-bottom: 10px;
          padding: 10px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 8px;
          border-left: 4px solid var(--secondary);
        }

        .vehicle-info strong {
          color: var(--secondary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
          .vehicle-selection-content {
            padding: 30px 20px;
            margin: 20px;
          }
          
          .vehicle-options {
            grid-template-columns: 1fr;
            gap: 20px;
          }
          
          .header {
            height: 50px;
            padding: 0 15px;
          }
          
          .header h1 {
            font-size: 1rem;
          }
          
          .score-system {
            gap: 8px;
          }
          
          .score-item {
            font-size: 0.8rem;
            padding: 6px 8px;
          }
          
          .info-panel {
            max-width: 200px;
            font-size: 0.8rem;
          }
          
          .controls-panel {
            max-width: 160px;
          }
          
          .control-btn {
            font-size: 0.75rem;
            padding: 8px 10px;
          }
          
          .speed-indicator {
            width: 80px;
            height: 80px;
            right: 180px;
          }
          
          .speed-value {
            font-size: 1.4rem;
          }

          .vehicle-inspection-content {
            padding: 20px;
            margin: 10px;
          }

          .vehicle-specs {
            grid-template-columns: 1fr;
          }

          .vehicle-3d-viewer {
            height: 300px;
          }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- Vehicle Selection Modal -->
        <div class="vehicle-selection-modal" id="vehicleSelection">
            <div class="vehicle-selection-content">
                <h1>üö¶ Simulasi Lalu Lintas Indonesia</h1>
                <p>
                    Simpang 4 tengah kota dengan <strong>Yellow Box Junction</strong>, <strong>Red Stop Box</strong>, dan sistem jalan yang realistis
                </p>
                
                <div class="vehicle-options">
                    <button class="vehicle-option car" onclick="selectVehicle('car')">
                        <div class="vehicle-image">üöó</div>
                        <strong>Mobil Sedan</strong>
                        <br><small>Kendaraan bermotor roda empat</small>
                    </button>
                    
                    <button class="vehicle-option motorcycle" onclick="selectVehicle('motorcycle')">
                        <div class="vehicle-image">üèçÔ∏è</div>
                        <strong>Sepeda Motor</strong>
                        <br><small>Kendaraan bermotor roda dua</small>
                    </button>
                    
                    <button class="vehicle-option pedestrian" onclick="selectVehicle('pedestrian')">
                        <div class="vehicle-image">üö∂</div>
                        <strong>Pejalan Kaki</strong>
                        <br><small>Pengguna jalan non-kendaraan</small>
                    </button>
                </div>

                <div class="feature-list">
                    <h3>üõ£Ô∏è Fitur Simpang 4 Tengah Kota:</h3>
                    <ul>
                        <li><strong>Simpang 4:</strong> Persimpangan 4 arah seperti di tengah kota</li>
                        <li><strong>Jalan Mayor:</strong> 2 jalur per arah (Utara-Selatan & Timur-Barat)</li>
                        <li><strong>Jalan Minor:</strong> 1 jalur per arah untuk akses lokal</li>
                        <li><strong>Zebra Cross:</strong> Di depan persimpangan untuk pejalan kaki</li>
                        <li><strong>Stop Line:</strong> Di belakang zebra cross sebagai batas berhenti</li>
                        <li><strong>Red Stop Box:</strong> Area merah tempat berhenti di lampu merah</li>
                        <li><strong>Yellow Box Junction:</strong> Area kuning di persimpangan (dilarang berhenti)</li>
                        <li><strong>Pemeriksa Kendaraan 3D:</strong> Inspeksi kendaraan dengan tampilan 3D</li>
                        <li><strong>Traffic Light:</strong> Lampu lalu lintas 3 warna dengan timing Indonesia</li>
                        <li><strong>Lane Markings:</strong> Marka jalan putih dan kuning sesuai standar</li>
                        <li><strong>Sidewalk:</strong> Trotoar abu-abu untuk pejalan kaki</li>
                        <li><strong>AI Traffic:</strong> Kendaraan AI yang mematuhi aturan lalu lintas</li>
                        <li><strong>3D Vehicle Rotation:</strong> Kendaraan berputar secara realistis</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Vehicle Inspection Modal -->
        <div class="vehicle-inspection-modal" id="vehicleInspectionModal">
            <div class="vehicle-inspection-content">
                <div class="inspection-header">
                    <h2>üîç Pemeriksaan Kendaraan</h2>
                    <p>Inspeksi detail kendaraan Anda seperti di game balap profesional</p>
                </div>

                <div class="vehicle-3d-viewer" id="vehicle3DViewer">
                    <div class="vehicle-3d-controls">
                        <button class="rotate-btn" onclick="rotateVehicle3D('left')">‚¨ÖÔ∏è Putar Kiri</button>
                        <button class="rotate-btn" onclick="rotateVehicle3D('right')">‚û°Ô∏è Putar Kanan</button>
                        <button class="rotate-btn" onclick="rotateVehicle3D('up')">‚¨ÜÔ∏è Atas</button>
                        <button class="rotate-btn" onclick="rotateVehicle3D('down')">‚¨áÔ∏è Bawah</button>
                        <button class="rotate-btn" onclick="resetVehicle3D()">üîÑ Reset</button>
                    </div>
                </div>

                <div class="vehicle-specs">
                    <div class="spec-card">
                        <h4>üöó Spesifikasi Kendaraan</h4>
                        <div class="spec-item">
                            <span class="spec-label">Jenis:</span>
                            <span class="spec-value" id="inspectVehicleType">-</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Kecepatan Max:</span>
                            <span class="spec-value" id="inspectMaxSpeed">-</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Berat:</span>
                            <span class="spec-value" id="inspectWeight">-</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Dimensi:</span>
                            <span class="spec-value" id="inspectDimensions">-</span>
                        </div>
                    </div>

                    <div class="spec-card">
                        <h4>‚ö° Status Real-time</h4>
                        <div class="spec-item">
                            <span class="spec-label">Kecepatan:</span>
                            <span class="spec-value" id="inspectCurrentSpeed">0 km/h</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Arah:</span>
                            <span class="spec-value" id="inspectDirection">Utara</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Rotasi:</span>
                            <span class="spec-value" id="inspectRotation">0¬∞</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Posisi:</span>
                            <span class="spec-value" id="inspectPosition">0, 0</span>
                        </div>
                    </div>

                    <div class="spec-card">
                        <h4>‚öñÔ∏è Status Hukum</h4>
                        <div class="spec-item">
                            <span class="spec-label">Status:</span>
                            <span class="spec-value" id="inspectLegalStatus">Patuh</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Pelanggaran:</span>
                            <span class="spec-value" id="inspectViolations">0</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Skor:</span>
                            <span class="spec-value" id="inspectScore">1000</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Level:</span>
                            <span class="spec-value" id="inspectLevel">1</span>
                        </div>
                    </div>
                </div>

                <div class="inspection-actions">
                    <button class="action-btn primary" onclick="closeVehicleInspection()">‚úÖ Selesai Periksa</button>
                    <button class="action-btn secondary" onclick="changeVehicleFromInspection()">üîÑ Ganti Kendaraan</button>
                </div>
            </div>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="loading-spinner"></div>
            üõ£Ô∏è Memuat Simpang 4 Tengah Kota<br>
            <small>Menyiapkan persimpangan dengan 4 jalur utama...</small>
        </div>

        <div class="ui-overlay" style="display: none;" id="gameUI">
            <div class="header">
                <h1>
                    <span id="vehicleIcon">üöó</span>
                    Simulasi Simpang 4 Tengah Kota
                </h1>
                <div class="score-system">
                    <div class="score-item">
                        <span>‚≠ê</span>
                        <span>Skor: <span id="score">1000</span></span>
                    </div>
                    <div class="score-item">
                        <span>‚ö†Ô∏è</span>
                        <span>Pelanggaran: <span id="violations">0</span></span>
                    </div>
                    <div class="score-item">
                        <span>üèÅ</span>
                        <span>Level: <span id="level">1</span></span>
                    </div>
                    <div class="score-item">
                        <span>üïí</span>
                        <span>Waktu: <span id="gameTime">00:00</span></span>
                    </div>
                </div>
            </div>

            <div class="speed-indicator">
                <div class="speed-content">
                    <div class="speed-value" id="speedValue">0</div>
                    <div class="speed-unit">KM/H</div>
                    <div class="speed-limit">Max: 40</div>
                </div>
            </div>

            <div class="panel info-panel">
                <h3>üìä Status Kendaraan</h3>
                <div id="currentInstruction">
                    <p><strong>üéÆ Kontrol:</strong> <span id="controlInfo">WASD / Arrow Keys</span></p>
                    <p><strong>üö¶ Lampu Lalu Lintas:</strong> <span id="trafficLight">Hijau</span></p>
                    <p><strong>üìç Lokasi:</strong> <span id="currentLocation">Simpang 4</span></p>
                    <p><strong>üõ£Ô∏è Jalur:</strong> <span id="currentLane">Kendaraan</span></p>
                    <p><strong>‚ö° Kecepatan:</strong> <span id="currentSpeed">0 km/h</span></p>
                    <p><strong>üèôÔ∏è Kepadatan:</strong> <span id="trafficDensity">Sedang</span></p>
                    <p><strong>üö∂ Pejalan Kaki:</strong> <span id="pedestrianCount">0</span></p>
                    <p><strong>‚öñÔ∏è Status Hukum:</strong> <span id="legalStatus">Patuh</span></p>
                </div>
            </div>

            <div class="panel inspector-panel" id="inspectorPanel">
                <h3>üîç Pemeriksa Kendaraan</h3>
                <div id="vehicleInspection">
                    <div class="vehicle-info">
                        <strong>Jenis:</strong> <span id="quickInspectVehicleType">-</span>
                    </div>
                    <div class="vehicle-info">
                        <strong>Kecepatan:</strong> <span id="quickInspectSpeed">0 km/h</span>
                    </div>
                    <div class="vehicle-info">
                        <strong>Arah:</strong> <span id="quickInspectDirection">Utara</span>
                    </div>
                    <div class="vehicle-info">
                        <strong>Status:</strong> <span id="quickInspectStatus">Normal</span>
                    </div>
                    <div class="vehicle-info">
                        <strong>Rotasi:</strong> <span id="quickInspectRotation">0¬∞</span>
                    </div>
                    <div class="vehicle-info">
                        <strong>Posisi:</strong> <span id="quickInspectPosition">0, 0</span>
                    </div>
                    <button class="control-btn" onclick="openVehicleInspection()" style="width: 100%; margin-top: 10px;">
                        üîç Periksa Detail 3D
                    </button>
                </div>
            </div>

            <div class="panel controls-panel">
                <button class="control-btn" onclick="startEngine()" id="engineBtn">üîë Start</button>
                <button class="control-btn" onclick="useHorn()">üìØ Klakson</button>
                <button class="control-btn" onclick="toggleLights()">üí° Lampu</button>
                <button class="control-btn" onclick="emergencyBrake()">üö® Rem</button>
                <button class="control-btn" onclick="toggleCamera()">üì∑ Kamera</button>
                <button class="control-btn" onclick="toggleInspector()" id="inspectorBtn">üîç Periksa</button>
            </div>

            <div class="violation-notification" id="violationNotification">
                <div id="violationMessage"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ===== TRAFFIC VIOLATIONS BASED ON UU NO. 22 TAHUN 2009 =====
        const VIOLATIONS = {
            RED_LIGHT: {
                code: 'Pasal 287 ayat (2)',
                description: 'Melanggar lampu merah',
                fine: 500000,
                severity: 'major'
            },
            SPEEDING: {
                code: 'Pasal 287 ayat (5)', 
                description: 'Melanggar batas kecepatan',
                fine: 500000,
                severity: 'minor'
            },
            WRONG_LANE: {
                code: 'Pasal 287 ayat (3)',
                description: 'Melanggar jalur lalu lintas',
                fine: 250000,
                severity: 'minor'
            },
            YELLOW_BOX: {
                code: 'Pasal 106 ayat (4)',
                description: 'Berhenti di Yellow Box Junction',
                fine: 250000,
                severity: 'minor'
            },
            STOP_BOX: {
                code: 'Pasal 113',
                description: 'Melewati Red Stop Box saat lampu merah',
                fine: 500000,
                severity: 'major'
            },
            PEDESTRIAN_CROSSING: {
                code: 'Pasal 106 ayat (2)',
                description: 'Tidak mengutamakan pejalan kaki',
                fine: 500000,
                severity: 'major'
            }
        }

        // ===== GAME STATE MANAGEMENT =====
        const gameState = {
            selectedVehicle: null,
            score: 1000,
            violations: 0,
            level: 1,
            gameTime: 0,
            currentSpeed: 0,
            isEngineStarted: false,
            lightsOn: false,
            keys: {},
            cameraMode: 0,
            currentSpeedLimit: 40,
            currentLane: 'vehicle',
            currentRoadType: 'major', // 'major' or 'minor'
            trafficLights: [],
            otherVehicles: [],
            pedestrians: [],
            lastViolationTime: 0,
            nearTrafficLight: false,
            currentTrafficLightState: 'green',
            hasStoppedAtRedLight: false,
            gameLoaded: false,
            pedestrianCrossing: false,
            inYellowBox: false,
            inRedStopBox: false,
            inspectorMode: false,
            vehicleRotationY: 0,
            targetRotationY: 0,
            inspection3DRotationX: 0,
            inspection3DRotationY: 0,
            inspectionVehicle: null,
            inspectionScene: null,
            inspectionCamera: null,
            inspectionRenderer: null
        }

        // Three.js variables
        let scene, camera, renderer, playerVehicle
        const clock = new THREE.Clock()

        // ===== ERROR HANDLING =====
        window.addEventListener('error', function(e) {
            console.error('Game Error:', e.error);
            showErrorMessage('Terjadi kesalahan saat memuat simulasi. Silakan refresh halaman.');
        });

        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <h3>‚ö†Ô∏è Error</h3>
                <p>${message}</p>
                <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #fff; color: #ef4444; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    üîÑ Refresh Halaman
                </button>
            `;
            document.body.appendChild(errorDiv);
        }

        // ===== INITIALIZATION =====
        function selectVehicle(vehicleType) {
            try {
                gameState.selectedVehicle = vehicleType
                document.getElementById('vehicleSelection').style.display = 'none'
                
                const vehicleIcons = {
                    car: 'üöó',
                    motorcycle: 'üèçÔ∏è',
                    pedestrian: 'üö∂'
                }
                document.getElementById('vehicleIcon').textContent = vehicleIcons[vehicleType]
                
                startGame()
            } catch (error) {
                console.error('Error selecting vehicle:', error);
                showErrorMessage('Gagal memilih kendaraan. Silakan coba lagi.');
            }
        }

        function startGame() {
            try {
                document.getElementById('loading').style.display = 'block'
                
                setTimeout(() => {
                    initThreeJS()
                }, 1000)
            } catch (error) {
                console.error('Error starting game:', error);
                showErrorMessage('Gagal memulai simulasi. Silakan refresh halaman.');
            }
        }

        function initThreeJS() {
            try {
                // Initialize Three.js scene
                scene = new THREE.Scene()
                scene.background = new THREE.Color(0x87ceeb)
                scene.fog = new THREE.Fog(0x87ceeb, 100, 400)

                // Initialize camera
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 600)
                camera.position.set(0, 20, 40)

                // Initialize renderer
                renderer = new THREE.WebGLRenderer({ antialias: true })
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))
                renderer.setSize(window.innerWidth, window.innerHeight)
                renderer.shadowMap.enabled = true
                renderer.shadowMap.type = THREE.PCFSoftShadowMap
                
                document.getElementById('gameContainer').appendChild(renderer.domElement)
                renderer.domElement.id = 'renderer'

                // Setup lighting
                setupLighting()
                
                // Create Indonesian road system
                createSimpleCityIntersection()
                
                // Create player vehicle
                createPlayerVehicle()
                
                // Setup camera
                setupCamera()
                
                // Setup event listeners
                setupEventListeners()
                
                // Start game loops
                startGameLoop()
                
                // Start animation
                animate()
                
                // Hide loading and show UI
                document.getElementById('loading').style.display = 'none'
                document.getElementById('gameUI').style.display = 'block'
                
                gameState.gameLoaded = true
                showMessage('üõ£Ô∏è Simpang 4 tengah kota siap! Zebra cross di depan, stop line di belakang.', 'success')
                
            } catch (error) {
                console.error('Error initializing Three.js:', error);
                document.getElementById('loading').style.display = 'none'
                showErrorMessage('Gagal memuat grafik 3D. Browser Anda mungkin tidak mendukung WebGL.');
            }
        }

        function setupLighting() {
            // Ambient light for general illumination
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6)
            scene.add(ambientLight)

            // Main sun light
            const sunLight = new THREE.DirectionalLight(0xffffff, 1)
            sunLight.position.set(150, 150, 100)
            sunLight.castShadow = true
            sunLight.shadow.mapSize.width = 2048
            sunLight.shadow.mapSize.height = 2048
            sunLight.shadow.camera.near = 0.5
            sunLight.shadow.camera.far = 300
            sunLight.shadow.camera.left = -150
            sunLight.shadow.camera.right = 150
            sunLight.shadow.camera.top = 150
            sunLight.shadow.camera.bottom = -150
            scene.add(sunLight)

            // Additional fill light
            const fillLight = new THREE.DirectionalLight(0x87ceeb, 0.4)
            fillLight.position.set(-80, 80, -50)
            scene.add(fillLight)
        }

        function createSimpleCityIntersection() {
            // Create base terrain
            createTerrain()
            
            // Create simple 4-way intersection
            createFourWayIntersection()
            
            // Create intersection with Yellow Box and Red Stop Boxes
            createIntersectionWithBoxes()
            
            // Create sidewalks
            createSimpleSidewalks()
            
            // Create road markings
            createSimpleRoadMarkings()
            
            // Create traffic lights
            createTrafficLights()
            
            // Create simple urban environment
            createSimpleUrbanEnvironment()
            
            // Spawn traffic
            spawnInitialTraffic()
            spawnPedestrians()
        }

        function createTerrain() {
            // Create grass base terrain
            const terrainGeometry = new THREE.PlaneGeometry(300, 300)
            const grassMaterial = new THREE.MeshLambertMaterial({ color: 0x2d5a2d })
            
            const terrain = new THREE.Mesh(terrainGeometry, grassMaterial)
            terrain.rotation.x = -Math.PI / 2
            terrain.receiveShadow = true
            scene.add(terrain)
        }

        function createFourWayIntersection() {
            const roadMaterial = new THREE.MeshLambertMaterial({ color: 0x2c2c2c })
            
            // Horizontal road (Timur-Barat) - Mayor 2 jalur per arah
            const hRoadGeometry = new THREE.PlaneGeometry(200, 24)
            const hRoad = new THREE.Mesh(hRoadGeometry, roadMaterial)
            hRoad.rotation.x = -Math.PI / 2
            hRoad.position.y = 0.1
            hRoad.receiveShadow = true
            scene.add(hRoad)
            
            // Vertical road (Utara-Selatan) - Mayor 2 jalur per arah
            const vRoadGeometry = new THREE.PlaneGeometry(24, 200)
            const vRoad = new THREE.Mesh(vRoadGeometry, roadMaterial)
            vRoad.rotation.x = -Math.PI / 2
            vRoad.position.y = 0.1
            vRoad.receiveShadow = true
            scene.add(vRoad)
            
            // Minor roads - 1 jalur per arah (lebih sempit)
            const minorRoadPositions = [
                // North minor access
                { x: 0, z: 60, width: 120, height: 8 },
                // South minor access  
                { x: 0, z: -60, width: 120, height: 8 },
                // East minor access
                { x: 60, z: 0, width: 8, height: 120 },
                // West minor access
                { x: -60, z: 0, width: 8, height: 120 }
            ]
            
            minorRoadPositions.forEach(pos => {
                const roadGeometry = new THREE.PlaneGeometry(pos.width, pos.height)
                const road = new THREE.Mesh(roadGeometry, roadMaterial)
                road.rotation.x = -Math.PI / 2
                road.position.set(pos.x, 0.1, pos.z)
                road.receiveShadow = true
                scene.add(road)
            })
        }

        function createIntersectionWithBoxes() {
            // Yellow Box Junction in center (dilarang berhenti)
            const yellowBoxGeometry = new THREE.PlaneGeometry(30, 30)
            const yellowBoxMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xffff00,
                transparent: true,
                opacity: 0.8
            })
            const yellowBox = new THREE.Mesh(yellowBoxGeometry, yellowBoxMaterial)
            yellowBox.rotation.x = -Math.PI / 2
            yellowBox.position.set(0, 0.15, 0)
            scene.add(yellowBox)
            
            // Yellow box border lines
            createYellowBoxBorder()
            
            // Red Stop Boxes at each approach (DI BELAKANG ZEBRA CROSS)
            const redStopBoxPositions = [
                { x: 0, z: 25, width: 24, height: 6 },   // North approach - di belakang zebra
                { x: 0, z: -25, width: 24, height: 6 },  // South approach - di belakang zebra
                { x: 25, z: 0, width: 6, height: 24 },   // East approach - di belakang zebra
                { x: -25, z: 0, width: 6, height: 24 }   // West approach - di belakang zebra
            ]
            
            redStopBoxPositions.forEach(pos => {
                const redStopBoxGeometry = new THREE.PlaneGeometry(pos.width, pos.height)
                const redStopBoxMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0xff0000,
                    transparent: true,
                    opacity: 0.7
                })
                const redStopBox = new THREE.Mesh(redStopBoxGeometry, redStopBoxMaterial)
                redStopBox.rotation.x = -Math.PI / 2
                redStopBox.position.set(pos.x, 0.12, pos.z)
                scene.add(redStopBox)
            })
        }

        function createYellowBoxBorder() {
            const borderMaterial = new THREE.MeshLambertMaterial({ color: 0xffff00 })
            
            // Create yellow border lines around the yellow box
            const borderPositions = [
                // Top border
                { x: 0, z: 15, width: 30, height: 0.3 },
                // Bottom border
                { x: 0, z: -15, width: 30, height: 0.3 },
                // Left border
                { x: -15, z: 0, width: 0.3, height: 30 },
                // Right border
                { x: 15, z: 0, width: 0.3, height: 30 }
            ]
            
            borderPositions.forEach(pos => {
                const border = new THREE.Mesh(
                    new THREE.BoxGeometry(pos.width, 0.02, pos.height),
                    borderMaterial
                )
                border.position.set(pos.x, 0.16, pos.z)
                scene.add(border)
            })
        }

        function createSimpleSidewalks() {
            const sidewalkMaterial = new THREE.MeshLambertMaterial({ color: 0x8b8b8b })
            
            // Sidewalks around the intersection
            const sidewalkPositions = [
                // North sidewalks
                { x: 0, z: 15, width: 200, depth: 3 },
                { x: 0, z: -15, width: 200, depth: 3 },
                // East/West sidewalks
                { x: 15, z: 0, width: 3, depth: 200 },
                { x: -15, z: 0, width: 3, depth: 200 }
            ]
            
            sidewalkPositions.forEach(pos => {
                const sidewalkGeometry = new THREE.PlaneGeometry(pos.width, pos.depth)
                const sidewalk = new THREE.Mesh(sidewalkGeometry, sidewalkMaterial)
                sidewalk.rotation.x = -Math.PI / 2
                sidewalk.position.set(pos.x, 0.25, pos.z)
                sidewalk.receiveShadow = true
                sidewalk.castShadow = true
                scene.add(sidewalk)
            })
        }

        function createSimpleRoadMarkings() {
            const whiteMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff })
            
            // Lane markings for major roads
            createMajorRoadMarkings(whiteMaterial)
            
            // Stop lines DI BELAKANG ZEBRA CROSS
            createStopLines(whiteMaterial)
            
            // Zebra crossings DI DEPAN (lebih jauh dari persimpangan)
            createZebraCrossings(whiteMaterial)
        }

        function createMajorRoadMarkings(whiteMaterial) {
            // Horizontal road lane markings (2 jalur per arah)
            for (let x = -90; x < 90; x += 10) {
                if (Math.abs(x) > 20) { // Skip intersection area
                    // Lane dividers untuk 2 jalur per arah
                    [-8, 8].forEach(zOffset => {
                        const marking = new THREE.Mesh(
                            new THREE.BoxGeometry(6, 0.02, 0.2),
                            whiteMaterial
                        )
                        marking.position.set(x, 0.12, zOffset)
                        scene.add(marking)
                    })
                }
            }
            
            // Vertical road lane markings (2 jalur per arah)
            for (let z = -90; z < 90; z += 10) {
                if (Math.abs(z) > 20) { // Skip intersection area
                    // Lane dividers untuk 2 jalur per arah
                    [-8, 8].forEach(xOffset => {
                        const marking = new THREE.Mesh(
                            new THREE.BoxGeometry(0.2, 0.02, 6),
                            whiteMaterial
                        )
                        marking.position.set(xOffset, 0.12, z)
                        scene.add(marking)
                    })
                }
            }
        }

        function createStopLines(whiteMaterial) {
            // Stop lines DI BELAKANG ZEBRA CROSS (lebih dekat ke persimpangan)
            const stopLinePositions = [
                { x: 0, z: 20, width: 24, depth: 0.5 },   // North approach - di belakang zebra
                { x: 0, z: -20, width: 24, depth: 0.5 },  // South approach - di belakang zebra
                { x: 20, z: 0, width: 0.5, depth: 24 },   // East approach - di belakang zebra
                { x: -20, z: 0, width: 0.5, depth: 24 }   // West approach - di belakang zebra
            ]
            
            stopLinePositions.forEach(pos => {
                const stopLine = new THREE.Mesh(
                    new THREE.BoxGeometry(pos.width, 0.02, pos.depth),
                    whiteMaterial
                )
                stopLine.position.set(pos.x, 0.13, pos.z)
                scene.add(stopLine)
            })
        }

        function createZebraCrossings(whiteMaterial) {
            // ZEBRA CROSS DI DEPAN (lebih jauh dari persimpangan)
            const crossingPositions = [
                { x: 0, z: 40, rotation: 0 },    // North crossing - DI DEPAN
                { x: 0, z: -40, rotation: 0 },   // South crossing - DI DEPAN
                { x: 40, z: 0, rotation: Math.PI/2 }, // East crossing - DI DEPAN
                { x: -40, z: 0, rotation: Math.PI/2 } // West crossing - DI DEPAN
            ]
            
            crossingPositions.forEach(pos => {
                for (let i = -12; i <= 12; i += 2) {
                    const stripe = new THREE.Mesh(
                        new THREE.BoxGeometry(1.5, 0.02, 20),
                        whiteMaterial
                    )
                    
                    if (pos.rotation === 0) {
                        stripe.position.set(pos.x + i, 0.13, pos.z)
                    } else {
                        stripe.position.set(pos.x, 0.13, pos.z + i)
                        stripe.rotation.y = pos.rotation
                    }
                    scene.add(stripe)
                }
            })
        }

        function createTrafficLights() {
            const lightPositions = [
                { x: 25, z: 25 },   // Northeast
                { x: -25, z: 25 },  // Northwest  
                { x: 25, z: -25 },  // Southeast
                { x: -25, z: -25 }  // Southwest
            ]
            
            lightPositions.forEach((pos, index) => {
                const lightGroup = createTrafficLight()
                lightGroup.position.set(pos.x, 0, pos.z)
                scene.add(lightGroup)
                
                gameState.trafficLights.push({
                    group: lightGroup,
                    position: pos,
                    state: index < 2 ? 'green' : 'red',
                    timer: 0,
                    redLight: lightGroup.children.find(child => child.userData && child.userData.type === 'red'),
                    yellowLight: lightGroup.children.find(child => child.userData && child.userData.type === 'yellow'),
                    greenLight: lightGroup.children.find(child => child.userData && child.userData.type === 'green')
                })
            })
        }

        function createTrafficLight() {
            const group = new THREE.Group()
            
            // Pole
            const poleGeometry = new THREE.CylinderGeometry(0.15, 0.15, 10)
            const poleMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 })
            const pole = new THREE.Mesh(poleGeometry, poleMaterial)
            pole.position.y = 5
            pole.castShadow = true
            group.add(pole)
            
            // Housing
            const housingGeometry = new THREE.BoxGeometry(1.5, 5, 0.8)
            const housingMaterial = new THREE.MeshLambertMaterial({ color: 0x1a1a1a })
            const housing = new THREE.Mesh(housingGeometry, housingMaterial)
            housing.position.y = 12
            housing.castShadow = true
            group.add(housing)
            
            // Lights
            const lightGeometry = new THREE.SphereGeometry(0.4, 8, 8)
            
            // Red light
            const redMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x660000, 
                emissive: 0x330000 
            })
            const redLight = new THREE.Mesh(lightGeometry, redMaterial)
            redLight.position.set(0, 13.5, 0.45)
            redLight.userData = { type: 'red' }
            group.add(redLight)
            
            // Yellow light
            const yellowMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x666600, 
                emissive: 0x333300 
            })
            const yellowLight = new THREE.Mesh(lightGeometry, yellowMaterial)
            yellowLight.position.set(0, 12, 0.45)
            yellowLight.userData = { type: 'yellow' }
            group.add(yellowLight)
            
            // Green light
            const greenMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x006600, 
                emissive: 0x003300 
            })
            const greenLight = new THREE.Mesh(lightGeometry, greenMaterial)
            greenLight.position.set(0, 10.5, 0.45)
            greenLight.userData = { type: 'green' }
            group.add(greenLight)
            
            return group
        }

        function createSimpleUrbanEnvironment() {
            // Create corner buildings
            createCornerBuildings()
            
            // Create street lights
            createStreetLights()
        }

        function createCornerBuildings() {
            const buildingData = [
                // Corner buildings around intersection
                { x: -60, z: 60, width: 30, height: 35, depth: 30, color: 0x4a90e2 },
                { x: 60, z: 60, width: 35, height: 40, depth: 30, color: 0x5cb85c },
                { x: -60, z: -60, width: 30, height: 30, depth: 35, color: 0xf0ad4e },
                { x: 60, z: -60, width: 40, height: 45, depth: 30, color: 0xd9534f }
            ]
            
            buildingData.forEach(data => {
                const building = createBuilding(data)
                scene.add(building)
            })
        }

        function createBuilding(data) {
            const group = new THREE.Group()
            
            // Main building
            const buildingGeometry = new THREE.BoxGeometry(data.width, data.height, data.depth)
            const buildingMaterial = new THREE.MeshLambertMaterial({ color: data.color })
            const building = new THREE.Mesh(buildingGeometry, buildingMaterial)
            
            building.position.set(data.x, data.height / 2, data.z)
            building.castShadow = true
            building.receiveShadow = true
            group.add(building)
            
            // Windows
            const windowMaterial = new THREE.MeshLambertMaterial({ 
                color: Math.random() > 0.4 ? 0xffff88 : 0x333333,
                transparent: true,
                opacity: 0.9
            })
            
            const windowsX = Math.floor(data.width / 4)
            const windowsY = Math.floor(data.height / 4)
            
            // Front and back windows
            for (let x = 0; x < windowsX; x++) {
                for (let y = 1; y < windowsY; y++) {
                    // Front windows
                    const frontWindow = new THREE.Mesh(
                        new THREE.BoxGeometry(2, 2, 0.1),
                        windowMaterial
                    )
                    frontWindow.position.set(
                        data.x - data.width/2 + x * 4 + 2,
                        y * 4 + 2,
                        data.z + data.depth/2 + 0.05
                    )
                    group.add(frontWindow)
                    
                    // Back windows
                    const backWindow = new THREE.Mesh(
                        new THREE.BoxGeometry(2, 2, 0.1),
                        windowMaterial
                    )
                    backWindow.position.set(
                        data.x - data.width/2 + x * 4 + 2,
                        y * 4 + 2,
                        data.z - data.depth/2 - 0.05
                    )
                    backWindow.rotation.y = Math.PI
                    group.add(backWindow)
                }
            }
            
            return group
        }

        function createStreetLights() {
            const streetLightPositions = [
                { x: -30, z: 30 }, { x: 30, z: 30 },
                { x: -30, z: -30 }, { x: 30, z: -30 }
            ]
            
            streetLightPositions.forEach(pos => {
                const streetLight = createStreetLight()
                streetLight.position.set(pos.x, 0, pos.z)
                scene.add(streetLight)
            })
        }

        function createStreetLight() {
            const group = new THREE.Group()
            
            // Pole
            const poleGeometry = new THREE.CylinderGeometry(0.12, 0.15, 12)
            const poleMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 })
            const pole = new THREE.Mesh(poleGeometry, poleMaterial)
            pole.position.y = 6
            pole.castShadow = true
            group.add(pole)
            
            // Light fixture
            const fixtureGeometry = new THREE.SphereGeometry(0.6, 8, 8)
            const fixtureMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xffffff,
                emissive: 0x444400
            })
            const fixture = new THREE.Mesh(fixtureGeometry, fixtureMaterial)
            fixture.position.y = 12.5
            group.add(fixture)
            
            // Point light for illumination
            const pointLight = new THREE.PointLight(0xffffff, 0.5, 40)
            pointLight.position.y = 12.5
            pointLight.castShadow = true
            group.add(pointLight)
            
            return group
        }

        function spawnInitialTraffic() {
            // Spawn initial vehicles with moderate density
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    spawnAIVehicle()
                }, i * 3000)
            }
        }

        function spawnPedestrians() {
            // Spawn pedestrians at crosswalks
            for (let i = 0; i < 4; i++) {
                setTimeout(() => {
                    spawnPedestrian()
                }, i * 4000)
            }
        }

        function spawnPedestrian() {
            try {
                const pedestrian = createAIPedestrian()
                
                // Spawn at zebra crossings (di depan)
                const spawnPositions = [
                    { x: -20, z: 40, direction: new THREE.Vector3(1, 0, 0), target: { x: 20, z: 40 } },
                    { x: 20, z: 40, direction: new THREE.Vector3(-1, 0, 0), target: { x: -20, z: 40 } },
                    { x: -20, z: -40, direction: new THREE.Vector3(1, 0, 0), target: { x: 20, z: -40 } },
                    { x: 20, z: -40, direction: new THREE.Vector3(-1, 0, 0), target: { x: -20, z: -40 } },
                    { x: 40, z: -20, direction: new THREE.Vector3(0, 0, 1), target: { x: 40, z: 20 } },
                    { x: 40, z: 20, direction: new THREE.Vector3(0, 0, -1), target: { x: 40, z: -20 } },
                    { x: -40, z: -20, direction: new THREE.Vector3(0, 0, 1), target: { x: -40, z: 20 } },
                    { x: -40, z: 20, direction: new THREE.Vector3(0, 0, -1), target: { x: -40, z: -20 } }
                ]
                
                const spawn = spawnPositions[Math.floor(Math.random() * spawnPositions.length)]
                pedestrian.position.set(spawn.x, 0, spawn.z)
                
                pedestrian.userData = {
                    type: 'pedestrian',
                    speed: 2.5 + Math.random() * 2,
                    direction: spawn.direction,
                    target: spawn.target,
                    waitingToCross: false,
                    crossing: false,
                    waitTime: 0
                }
                
                scene.add(pedestrian)
                gameState.pedestrians.push(pedestrian)
            } catch (error) {
                console.error('Error spawning pedestrian:', error);
            }
        }

        function createAIPedestrian() {
            const pedGroup = new THREE.Group()
            
            // Body
            const bodyGeometry = new THREE.CylinderGeometry(0.3, 0.35, 1.5)
            const bodyColors = [0x4169e1, 0xff6347, 0x32cd32, 0xffd700, 0x9370db, 0xff69b4]
            const bodyColor = bodyColors[Math.floor(Math.random() * bodyColors.length)]
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: bodyColor })
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
            body.position.y = 1.2
            body.castShadow = true
            pedGroup.add(body)
            
            // Head
            const headGeometry = new THREE.SphereGeometry(0.25)
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0x8b4513 })
            const head = new THREE.Mesh(headGeometry, headMaterial)
            head.position.y = 2.2
            head.castShadow = true
            pedGroup.add(head)
            
            // Arms
            const armGeometry = new THREE.CylinderGeometry(0.08, 0.1, 0.8)
            const armMaterial = new THREE.MeshLambertMaterial({ color: 0x8b4513 })
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial)
            leftArm.position.set(-0.4, 1.4, 0)
            leftArm.rotation.z = 0.3
            leftArm.castShadow = true
            pedGroup.add(leftArm)
            
            const rightArm = new THREE.Mesh(armGeometry, armMaterial)
            rightArm.position.set(0.4, 1.4, 0)
            rightArm.rotation.z = -0.3
            rightArm.castShadow = true
            pedGroup.add(rightArm)
            
            // Legs
            const legGeometry = new THREE.CylinderGeometry(0.1, 0.12, 1)
            const legMaterial = new THREE.MeshLambertMaterial({ color: 0x000080 })
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial)
            leftLeg.position.set(-0.15, 0.5, 0)
            leftLeg.castShadow = true
            pedGroup.add(leftLeg)
            
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial)
            rightLeg.position.set(0.15, 0.5, 0)
            rightLeg.castShadow = true
            pedGroup.add(rightLeg)
            
            return pedGroup
        }

        function spawnAIVehicle() {
            try {
                const vehicleType = Math.random() < 0.65 ? 'car' : 'motorcycle'
                const vehicle = vehicleType === 'car' ? createAICar() : createAIMotorcycle()
                
                const spawnPositions = [
                    // Major road spawns (4 arah utama)
                    { x: -100, z: -6, direction: new THREE.Vector3(1, 0, 0), roadType: 'major' },
                    { x: -100, z: 6, direction: new THREE.Vector3(1, 0, 0), roadType: 'major' },
                    { x: 100, z: -6, direction: new THREE.Vector3(-1, 0, 0), roadType: 'major' },
                    { x: 100, z: 6, direction: new THREE.Vector3(-1, 0, 0), roadType: 'major' },
                    { x: -6, z: -100, direction: new THREE.Vector3(0, 0, 1), roadType: 'major' },
                    { x: 6, z: -100, direction: new THREE.Vector3(0, 0, 1), roadType: 'major' },
                    { x: -6, z: 100, direction: new THREE.Vector3(0, 0, -1), roadType: 'major' },
                    { x: 6, z: 100, direction: new THREE.Vector3(0, 0, -1), roadType: 'major' },
                    
                    // Minor road spawns
                    { x: -80, z: 60, direction: new THREE.Vector3(1, 0, 0), roadType: 'minor' },
                    { x: 80, z: 60, direction: new THREE.Vector3(-1, 0, 0), roadType: 'minor' },
                    { x: -80, z: -60, direction: new THREE.Vector3(1, 0, 0), roadType: 'minor' },
                    { x: 80, z: -60, direction: new THREE.Vector3(-1, 0, 0), roadType: 'minor' },
                    { x: 60, z: -80, direction: new THREE.Vector3(0, 0, 1), roadType: 'minor' },
                    { x: 60, z: 80, direction: new THREE.Vector3(0, 0, -1), roadType: 'minor' },
                    { x: -60, z: -80, direction: new THREE.Vector3(0, 0, 1), roadType: 'minor' },
                    { x: -60, z: 80, direction: new THREE.Vector3(0, 0, -1), roadType: 'minor' }
                ]
                
                const spawn = spawnPositions[Math.floor(Math.random() * spawnPositions.length)]
                vehicle.position.set(spawn.x, 0, spawn.z)
                
                // Set initial rotation based on direction
                let initialRotation = 0
                if (spawn.direction.x > 0) initialRotation = Math.PI / 2
                else if (spawn.direction.x < 0) initialRotation = -Math.PI / 2
                else if (spawn.direction.z > 0) initialRotation = Math.PI
                else if (spawn.direction.z < 0) initialRotation = 0
                
                vehicle.rotation.y = initialRotation
                
                vehicle.userData = {
                    type: 'ai_vehicle',
                    vehicleType: vehicleType,
                    speed: 10 + Math.random() * 10,
                    direction: spawn.direction,
                    roadType: spawn.roadType,
                    stoppedAtLight: false,
                    stoppedForPedestrian: false,
                    waitTime: 0,
                    targetSpeed: spawn.roadType === 'major' ? 15 + Math.random() * 10 : 8 + Math.random() * 6,
                    rotationY: initialRotation,
                    targetRotationY: initialRotation
                }
                
                scene.add(vehicle)
                gameState.otherVehicles.push(vehicle)
            } catch (error) {
                console.error('Error spawning AI vehicle:', error);
            }
        }

        function createAICar() {
            const carGroup = new THREE.Group()
            
            const colors = [0xff3333, 0x3333ff, 0x33ff33, 0xffff33, 0xff33ff, 0x33ffff, 0xffffff, 0x333333, 0x800080, 0xffa500]
            const color = colors[Math.floor(Math.random() * colors.length)]
            
            // Main body
            const bodyGeometry = new THREE.BoxGeometry(4.5, 1.6, 2)
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: color })
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
            body.position.y = 1.3
            body.castShadow = true
            carGroup.add(body)
            
            // Roof
            const roofGeometry = new THREE.BoxGeometry(2.8, 1.2, 1.8)
            const roofMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x1a1a1a, 
                transparent: true, 
                opacity: 0.8 
            })
            const roof = new THREE.Mesh(roofGeometry, roofMaterial)
            roof.position.y = 2.4
            roof.castShadow = true
            carGroup.add(roof)
            
            // Wheels
            const wheelGeometry = new THREE.CylinderGeometry(0.45, 0.45, 0.35, 8)
            const wheelMaterial = new THREE.MeshLambertMaterial({ color: 0x1a1a1a })
            
            const wheelPositions = [
                { x: 1.6, y: 0.45, z: 1 },
                { x: 1.6, y: 0.45, z: -1 },
                { x: -1.6, y: 0.45, z: 1 },
                { x: -1.6, y: 0.45, z: -1 }
            ]
            
            wheelPositions.forEach(pos => {
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial)
                wheel.rotation.z = Math.PI / 2
                wheel.position.set(pos.x, pos.y, pos.z)
                wheel.castShadow = true
                carGroup.add(wheel)
            })
            
            // Headlights
            const headlightGeometry = new THREE.SphereGeometry(0.18, 8, 8)
            const headlightMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xffffff, 
                emissive: 0x333300 
            })
            
            const headlight1 = new THREE.Mesh(headlightGeometry, headlightMaterial)
            headlight1.position.set(2.3, 1.3, 0.7)
            carGroup.add(headlight1)
            
            const headlight2 = new THREE.Mesh(headlightGeometry, headlightMaterial)
            headlight2.position.set(2.3, 1.3, -0.7)
            carGroup.add(headlight2)
            
            return carGroup
        }

        function createAIMotorcycle() {
            const motorGroup = new THREE.Group()
            
            const colors = [0x0066cc, 0xcc6600, 0x6600cc, 0x00cc66, 0xcc0066, 0xff4500]
            const color = colors[Math.floor(Math.random() * colors.length)]
            
            // Main body
            const bodyGeometry = new THREE.BoxGeometry(2.2, 0.8, 0.6)
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: color })
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
            body.position.y = 1.1
            body.castShadow = true
            motorGroup.add(body)
            
            // Wheels
            const wheelGeometry = new THREE.CylinderGeometry(0.4, 0.4, 0.25, 8)
            const wheelMaterial = new THREE.MeshLambertMaterial({ color: 0x1a1a1a })
            
            const frontWheel = new THREE.Mesh(wheelGeometry, wheelMaterial)
            frontWheel.rotation.z = Math.PI / 2
            frontWheel.position.set(1.3, 0.4, 0)
            frontWheel.castShadow = true
            motorGroup.add(frontWheel)
            
            const rearWheel = new THREE.Mesh(wheelGeometry, wheelMaterial)
            rearWheel.rotation.z = Math.PI / 2
            rearWheel.position.set(-1.3, 0.4, 0)
            rearWheel.castShadow = true
            motorGroup.add(rearWheel)
            
            // Rider
            const rider = createAIPedestrian()
            rider.scale.set(0.7, 0.7, 0.7)
            rider.position.y = 1
            motorGroup.add(rider)
            
            // Headlight
            const headlightGeometry = new THREE.SphereGeometry(0.12, 8, 8)
            const headlightMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xffffff, 
                emissive: 0x444400 
            })
            
            const headlight = new THREE.Mesh(headlightGeometry, headlightMaterial)
            headlight.position.set(1.5, 1.3, 0)
            motorGroup.add(headlight)
            
            return motorGroup
        }

        function createPlayerVehicle() {
            try {
                if (gameState.selectedVehicle === 'car') {
                    playerVehicle = createPlayerCar()
                } else if (gameState.selectedVehicle === 'motorcycle') {
                    playerVehicle = createPlayerMotorcycle()
                } else {
                    playerVehicle = createPlayerPedestrian()
                }
                
                // Spawn player at edge of major road
                playerVehicle.position.set(-80, 0, -6)
                scene.add(playerVehicle)
            } catch (error) {
                console.error('Error creating player vehicle:', error);
                showErrorMessage('Gagal membuat kendaraan pemain.');
            }
        }

        function createPlayerCar() {
            const carGroup = new THREE.Group()
            
            // Main body
            const bodyGeometry = new THREE.BoxGeometry(5, 1.8, 2.2)
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 })
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
            body.position.y = 1.4
            body.castShadow = true
            carGroup.add(body)
            
            // Roof
            const roofGeometry = new THREE.BoxGeometry(3.2, 1.2, 2)
            const roofMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x1a1a1a, 
                transparent: true, 
                opacity: 0.8 
            })
            const roof = new THREE.Mesh(roofGeometry, roofMaterial)
            roof.position.y = 2.6
            roof.castShadow = true
            carGroup.add(roof)
            
            // Wheels
            const wheelGeometry = new THREE.CylinderGeometry(0.5, 0.5, 0.4, 12)
            const wheelMaterial = new THREE.MeshLambertMaterial({ color: 0x1a1a1a })
            
            const wheelPositions = [
                { x: 1.7, y: 0.5, z: 1.1 },
                { x: 1.7, y: 0.5, z: -1.1 },
                { x: -1.7, y: 0.5, z: 1.1 },
                { x: -1.7, y: 0.5, z: -1.1 }
            ]
            
            wheelPositions.forEach(pos => {
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial)
                wheel.rotation.z = Math.PI / 2
                wheel.position.set(pos.x, pos.y, pos.z)
                wheel.castShadow = true
                carGroup.add(wheel)
            })
            
            return carGroup
        }

        function createPlayerMotorcycle() {
            const motorGroup = new THREE.Group()
            
            // Main body
            const bodyGeometry = new THREE.BoxGeometry(2.5, 1, 0.7)
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x0066cc })
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
            body.position.y = 1.2
            body.castShadow = true
            motorGroup.add(body)
            
            // Wheels
            const wheelGeometry = new THREE.CylinderGeometry(0.45, 0.45, 0.3, 12)
            const wheelMaterial = new THREE.MeshLambertMaterial({ color: 0x1a1a1a })
            
            const frontWheel = new THREE.Mesh(wheelGeometry, wheelMaterial)
            frontWheel.rotation.z = Math.PI / 2
            frontWheel.position.set(1.4, 0.45, 0)
            frontWheel.castShadow = true
            motorGroup.add(frontWheel)
            
            const rearWheel = new THREE.Mesh(wheelGeometry, wheelMaterial)
            rearWheel.rotation.z = Math.PI / 2
            rearWheel.position.set(-1.4, 0.45, 0)
            rearWheel.castShadow = true
            motorGroup.add(rearWheel)
            
            return motorGroup
        }

        function createPlayerPedestrian() {
            const pedGroup = new THREE.Group()
            
            // Body
            const bodyGeometry = new THREE.CylinderGeometry(0.3, 0.35, 1.5)
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x4169e1 })
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
            body.position.y = 1.2
            body.castShadow = true
            pedGroup.add(body)
            
            // Head
            const headGeometry = new THREE.SphereGeometry(0.25)
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0x8b4513 })
            const head = new THREE.Mesh(headGeometry, headMaterial)
            head.position.y = 2.2
            head.castShadow = true
            pedGroup.add(head)
            
            return pedGroup
        }

        // ===== 3D VEHICLE INSPECTION SYSTEM =====
        function setup3DInspection() {
            try {
                // Create separate scene for 3D inspection
                gameState.inspectionScene = new THREE.Scene()
                gameState.inspectionScene.background = new THREE.Color(0x1a1a2e)
                
                // Setup inspection camera
                gameState.inspectionCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 100)
                gameState.inspectionCamera.position.set(5, 3, 5)
                
                // Setup inspection renderer
                const viewerElement = document.getElementById('vehicle3DViewer')
                gameState.inspectionRenderer = new THREE.WebGLRenderer({ antialias: true })
                gameState.inspectionRenderer.setSize(viewerElement.clientWidth, viewerElement.clientHeight)
                gameState.inspectionRenderer.shadowMap.enabled = true
                gameState.inspectionRenderer.shadowMap.type = THREE.PCFSoftShadowMap
                
                // Clear existing content and add renderer
                viewerElement.innerHTML = ''
                viewerElement.appendChild(gameState.inspectionRenderer.domElement)
                
                // Re-add controls
                const controlsDiv = document.createElement('div')
                controlsDiv.className = 'vehicle-3d-controls'
                controlsDiv.innerHTML = `
                    <button class="rotate-btn" onclick="rotateVehicle3D('left')">‚¨ÖÔ∏è Putar Kiri</button>
                    <button class="rotate-btn" onclick="rotateVehicle3D('right')">‚û°Ô∏è Putar Kanan</button>
                    <button class="rotate-btn" onclick="rotateVehicle3D('up')">‚¨ÜÔ∏è Atas</button>
                    <button class="rotate-btn" onclick="rotateVehicle3D('down')">‚¨áÔ∏è Bawah</button>
                    <button class="rotate-btn" onclick="resetVehicle3D()">üîÑ Reset</button>
                `
                viewerElement.appendChild(controlsDiv)
                
                // Setup lighting for inspection
                const ambientLight = new THREE.AmbientLight(0x404040, 0.8)
                gameState.inspectionScene.add(ambientLight)
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1)
                directionalLight.position.set(10, 10, 5)
                directionalLight.castShadow = true
                gameState.inspectionScene.add(directionalLight)
                
                const fillLight = new THREE.DirectionalLight(0x87ceeb, 0.5)
                fillLight.position.set(-5, 5, -5)
                gameState.inspectionScene.add(fillLight)
                
                // Create inspection vehicle
                createInspectionVehicle()
                
                // Start inspection animation loop
                animateInspection()
                
            } catch (error) {
                console.error('Error setting up 3D inspection:', error);
            }
        }

        function createInspectionVehicle() {
            if (gameState.inspectionVehicle) {
                gameState.inspectionScene.remove(gameState.inspectionVehicle)
            }
            
            // Create detailed inspection vehicle based on selected type
            if (gameState.selectedVehicle === 'car') {
                gameState.inspectionVehicle = createDetailedInspectionCar()
            } else if (gameState.selectedVehicle === 'motorcycle') {
                gameState.inspectionVehicle = createDetailedInspectionMotorcycle()
            } else {
                gameState.inspectionVehicle = createDetailedInspectionPedestrian()
            }
            
            gameState.inspectionVehicle.position.set(0, 0, 0)
            gameState.inspectionScene.add(gameState.inspectionVehicle)
            
            // Reset camera position
            gameState.inspectionCamera.position.set(5, 3, 5)
            gameState.inspectionCamera.lookAt(0, 1, 0)
        }

        function createDetailedInspectionCar() {
            const carGroup = new THREE.Group()
            
            // Main body with more detail
            const bodyGeometry = new THREE.BoxGeometry(4, 1.5, 1.8)
            const bodyMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xff0000,
                shininess: 100,
                specular: 0x222222
            })
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
            body.position.y = 1.2
            body.castShadow = true
            carGroup.add(body)
            
            // Detailed roof
            const roofGeometry = new THREE.BoxGeometry(2.5, 1, 1.6)
            const roofMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x1a1a1a,
                transparent: true,
                opacity: 0.9,
                shininess: 50
            })
            const roof = new THREE.Mesh(roofGeometry, roofMaterial)
            roof.position.y = 2.2
            roof.castShadow = true
            carGroup.add(roof)
            
            // Detailed wheels with rims
            const wheelPositions = [
                { x: 1.5, y: 0.4, z: 0.9 },
                { x: 1.5, y: 0.4, z: -0.9 },
                { x: -1.5, y: 0.4, z: 0.9 },
                { x: -1.5, y: 0.4, z: -0.9 }
            ]
            
            wheelPositions.forEach(pos => {
                // Tire
                const tireGeometry = new THREE.CylinderGeometry(0.4, 0.4, 0.3, 16)
                const tireMaterial = new THREE.MeshPhongMaterial({ color: 0x1a1a1a })
                const tire = new THREE.Mesh(tireGeometry, tireMaterial)
                tire.rotation.z = Math.PI / 2
                tire.position.set(pos.x, pos.y, pos.z)
                tire.castShadow = true
                carGroup.add(tire)
                
                // Rim
                const rimGeometry = new THREE.CylinderGeometry(0.25, 0.25, 0.32, 16)
                const rimMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xcccccc,
                    shininess: 100
                })
                const rim = new THREE.Mesh(rimGeometry, rimMaterial)
                rim.rotation.z = Math.PI / 2
                rim.position.set(pos.x, pos.y, pos.z)
                carGroup.add(rim)
            })
            
            // Headlights
            const headlightGeometry = new THREE.SphereGeometry(0.15, 12, 12)
            const headlightMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xffffff,
                emissive: 0x444400,
                shininess: 100
            })
            
            const headlight1 = new THREE.Mesh(headlightGeometry, headlightMaterial)
            headlight1.position.set(2.1, 1.2, 0.6)
            carGroup.add(headlight1)
            
            const headlight2 = new THREE.Mesh(headlightGeometry, headlightMaterial)
            headlight2.position.set(2.1, 1.2, -0.6)
            carGroup.add(headlight2)
            
            // Grille
            const grilleGeometry = new THREE.BoxGeometry(0.1, 0.8, 1.2)
            const grilleMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 })
            const grille = new THREE.Mesh(grilleGeometry, grilleMaterial)
            grille.position.set(2.05, 1.2, 0)
            carGroup.add(grille)
            
            // Side mirrors
            const mirrorGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.15)
            const mirrorMaterial = new THREE.MeshPhongMaterial({ color: 0x1a1a1a })
            
            const leftMirror = new THREE.Mesh(mirrorGeometry, mirrorMaterial)
            leftMirror.position.set(1.2, 2.1, 1)
            carGroup.add(leftMirror)
            
            const rightMirror = new THREE.Mesh(mirrorGeometry, mirrorMaterial)
            rightMirror.position.set(1.2, 2.1, -1)
            carGroup.add(rightMirror)
            
            return carGroup
        }

        function createDetailedInspectionMotorcycle() {
            const motorGroup = new THREE.Group()
            
            // Main body
            const bodyGeometry = new THREE.BoxGeometry(2, 0.6, 0.5)
            const bodyMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x0066cc,
                shininess: 100
            })
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
            body.position.y = 1
            body.castShadow = true
            motorGroup.add(body)
            
            // Detailed wheels
            const wheelPositions = [
                { x: 1.2, y: 0.35, z: 0 },
                { x: -1.2, y: 0.35, z: 0 }
            ]
            
            wheelPositions.forEach(pos => {
                // Tire
                const tireGeometry = new THREE.CylinderGeometry(0.35, 0.35, 0.2, 16)
                const tireMaterial = new THREE.MeshPhongMaterial({ color: 0x1a1a1a })
                const tire = new THREE.Mesh(tireGeometry, tireMaterial)
                tire.rotation.z = Math.PI / 2
                tire.position.set(pos.x, pos.y, pos.z)
                tire.castShadow = true
                motorGroup.add(tire)
                
                // Rim
                const rimGeometry = new THREE.CylinderGeometry(0.2, 0.2, 0.22, 16)
                const rimMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xcccccc,
                    shininess: 100
                })
                const rim = new THREE.Mesh(rimGeometry, rimMaterial)
                rim.rotation.z = Math.PI / 2
                rim.position.set(pos.x, pos.y, pos.z)
                motorGroup.add(rim)
            })
            
            // Handlebars
            const handlebarGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.8)
            const handlebarMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 })
            const handlebar = new THREE.Mesh(handlebarGeometry, handlebarMaterial)
            handlebar.rotation.z = Math.PI / 2
            handlebar.position.set(1, 1.5, 0)
            motorGroup.add(handlebar)
            
            // Seat
            const seatGeometry = new THREE.BoxGeometry(0.8, 0.2, 0.4)
            const seatMaterial = new THREE.MeshPhongMaterial({ color: 0x8b4513 })
            const seat = new THREE.Mesh(seatGeometry, seatMaterial)
            seat.position.set(-0.3, 1.3, 0)
            motorGroup.add(seat)
            
            // Headlight
            const headlightGeometry = new THREE.SphereGeometry(0.1, 12, 12)
            const headlightMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xffffff,
                emissive: 0x444400
            })
            const headlight = new THREE.Mesh(headlightGeometry, headlightMaterial)
            headlight.position.set(1.3, 1.2, 0)
            motorGroup.add(headlight)
            
            return motorGroup
        }

        function createDetailedInspectionPedestrian() {
            const pedGroup = new THREE.Group()
            
            // Body
            const bodyGeometry = new THREE.CylinderGeometry(0.25, 0.3, 1.2)
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0x4169e1 })
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
            body.position.y = 1
            body.castShadow = true
            pedGroup.add(body)
            
            // Head
            const headGeometry = new THREE.SphereGeometry(0.2, 12, 12)
            const headMaterial = new THREE.MeshPhongMaterial({ color: 0x8b4513 })
            const head = new THREE.Mesh(headGeometry, headMaterial)
            head.position.y = 1.8
            head.castShadow = true
            pedGroup.add(head)
            
            // Arms
            const armGeometry = new THREE.CylinderGeometry(0.06, 0.08, 0.6)
            const armMaterial = new THREE.MeshPhongMaterial({ color: 0x8b4513 })
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial)
            leftArm.position.set(-0.3, 1.2, 0)
            leftArm.rotation.z = 0.2
            leftArm.castShadow = true
            pedGroup.add(leftArm)
            
            const rightArm = new THREE.Mesh(armGeometry, armMaterial)
            rightArm.position.set(0.3, 1.2, 0)
            rightArm.rotation.z = -0.2
            rightArm.castShadow = true
            pedGroup.add(rightArm)
            
            // Legs
            const legGeometry = new THREE.CylinderGeometry(0.08, 0.1, 0.8)
            const legMaterial = new THREE.MeshPhongMaterial({ color: 0x000080 })
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial)
            leftLeg.position.set(-0.12, 0.4, 0)
            leftLeg.castShadow = true
            pedGroup.add(leftLeg)
            
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial)
            rightLeg.position.set(0.12, 0.4, 0)
            rightLeg.castShadow = true
            pedGroup.add(rightLeg)
            
            return pedGroup
        }

        function rotateVehicle3D(direction) {
            if (!gameState.inspectionVehicle) return
            
            const rotationSpeed = 0.2
            
            switch (direction) {
                case 'left':
                    gameState.inspection3DRotationY -= rotationSpeed
                    break
                case 'right':
                    gameState.inspection3DRotationY += rotationSpeed
                    break
                case 'up':
                    gameState.inspection3DRotationX -= rotationSpeed
                    gameState.inspection3DRotationX = Math.max(-Math.PI/3, gameState.inspection3DRotationX)
                    break
                case 'down':
                    gameState.inspection3DRotationX += rotationSpeed
                    gameState.inspection3DRotationX = Math.min(Math.PI/3, gameState.inspection3DRotationX)
                    break
            }
            
            gameState.inspectionVehicle.rotation.y = gameState.inspection3DRotationY
            gameState.inspectionVehicle.rotation.x = gameState.inspection3DRotationX
        }

        function resetVehicle3D() {
            gameState.inspection3DRotationX = 0
            gameState.inspection3DRotationY = 0
            
            if (gameState.inspectionVehicle) {
                gameState.inspectionVehicle.rotation.x = 0
                gameState.inspectionVehicle.rotation.y = 0
            }
            
            if (gameState.inspectionCamera) {
                gameState.inspectionCamera.position.set(5, 3, 5)
                gameState.inspectionCamera.lookAt(0, 1, 0)
            }
        }

        function animateInspection() {
            if (!gameState.inspectionRenderer || !gameState.inspectionScene || !gameState.inspectionCamera) return
            
            requestAnimationFrame(animateInspection)
            
            // Auto-rotate vehicle slowly
            if (gameState.inspectionVehicle && document.getElementById('vehicleInspectionModal').style.display !== 'none') {
                gameState.inspectionVehicle.rotation.y += 0.005
            }
            
            gameState.inspectionRenderer.render(gameState.inspectionScene, gameState.inspectionCamera)
        }

        function openVehicleInspection() {
            document.getElementById('vehicleInspectionModal').style.display = 'flex'
            
            // Setup 3D inspection if not already done
            if (!gameState.inspectionRenderer) {
                setTimeout(() => {
                    setup3DInspection()
                }, 100)
            } else {
                createInspectionVehicle()
            }
            
            updateInspectionSpecs()
            showMessage('üîç Mode inspeksi 3D diaktifkan! Gunakan tombol untuk memutar kendaraan.', 'info')
        }

        function closeVehicleInspection() {
            document.getElementById('vehicleInspectionModal').style.display = 'none'
            showMessage('üîç Mode inspeksi 3D ditutup.', 'info')
        }

        function changeVehicleFromInspection() {
            if (confirm('Yakin ingin mengganti kendaraan? Progress akan direset.')) {
                closeVehicleInspection()
                changeVehicle()
            }
        }

        function updateInspectionSpecs() {
            if (!playerVehicle) return
            
            // Vehicle specifications
            const vehicleSpecs = {
                'car': {
                    type: 'Mobil Sedan',
                    maxSpeed: '180 km/h',
                    weight: '1,200 kg',
                    dimensions: '4.5m x 1.8m x 2.2m'
                },
                'motorcycle': {
                    type: 'Sepeda Motor',
                    maxSpeed: '120 km/h',
                    weight: '150 kg',
                    dimensions: '2.5m x 1.0m x 0.7m'
                },
                'pedestrian': {
                    type: 'Pejalan Kaki',
                    maxSpeed: '8 km/h',
                    weight: '70 kg',
                    dimensions: '1.7m x 0.6m x 0.3m'
                }
            }
            
            const specs = vehicleSpecs[gameState.selectedVehicle]
            
            document.getElementById('inspectVehicleType').textContent = specs.type
            document.getElementById('inspectMaxSpeed').textContent = specs.maxSpeed
            document.getElementById('inspectWeight').textContent = specs.weight
            document.getElementById('inspectDimensions').textContent = specs.dimensions
            
            // Real-time status
            document.getElementById('inspectCurrentSpeed').textContent = `${Math.round(Math.abs(gameState.currentSpeed))} km/h`
            
            const rotationDegrees = (gameState.vehicleRotationY * 180 / Math.PI) % 360
            let direction = 'Utara'
            if (rotationDegrees >= -45 && rotationDegrees < 45) direction = 'Utara'
            else if (rotationDegrees >= 45 && rotationDegrees < 135) direction = 'Timur'
            else if (rotationDegrees >= 135 || rotationDegrees < -135) direction = 'Selatan'
            else if (rotationDegrees >= -135 && rotationDegrees < -45) direction = 'Barat'
            
            document.getElementById('inspectDirection').textContent = direction
            document.getElementById('inspectRotation').textContent = `${Math.round(rotationDegrees)}¬∞`
            document.getElementById('inspectPosition').textContent = 
                `${Math.round(playerVehicle.position.x)}, ${Math.round(playerVehicle.position.z)}`
            
            // Legal status
            let legalStatus = 'Patuh'
            if (gameState.nearTrafficLight && gameState.currentTrafficLightState === 'red') {
                legalStatus = 'Menunggu Lampu Merah'
            } else if (gameState.currentSpeed > gameState.currentSpeedLimit) {
                legalStatus = 'Melanggar Batas Kecepatan'
            } else if (gameState.inYellowBox) {
                legalStatus = 'Di Yellow Box'
            } else if (gameState.inRedStopBox) {
                legalStatus = 'Di Red Stop Box'
            }
            
            document.getElementById('inspectLegalStatus').textContent = legalStatus
            document.getElementById('inspectViolations').textContent = gameState.violations
            document.getElementById('inspectScore').textContent = Math.round(gameState.score)
            document.getElementById('inspectLevel').textContent = gameState.level
        }

        function setupCamera() {
            updateCameraPosition()
        }

        function updateCameraPosition() {
            if (!playerVehicle) return
            
            try {
                const vehiclePosition = playerVehicle.position
                const vehicleRotation = playerVehicle.rotation
                
                switch (gameState.cameraMode) {
                    case 0: // Third person
                        const offset = new THREE.Vector3(0, 20, -40)
                        offset.applyEuler(vehicleRotation)
                        camera.position.copy(vehiclePosition).add(offset)
                        camera.lookAt(vehiclePosition)
                        break
                        
                    case 1: // First person
                        let cockpitOffset = new THREE.Vector3(0, 3.5, 2.5)
                        if (gameState.selectedVehicle === 'motorcycle') {
                            cockpitOffset = new THREE.Vector3(0, 2.5, 1.2)
                        } else if (gameState.selectedVehicle === 'pedestrian') {
                            cockpitOffset = new THREE.Vector3(0, 2.2, 0.5)
                        }
                        cockpitOffset.applyEuler(vehicleRotation)
                        camera.position.copy(vehiclePosition).add(cockpitOffset)
                        const lookAhead = new THREE.Vector3(0, 0, 20)
                        lookAhead.applyEuler(vehicleRotation)
                        camera.lookAt(vehiclePosition.clone().add(lookAhead))
                        break
                        
                    case 2: // Overhead
                        camera.position.set(vehiclePosition.x, vehiclePosition.y + 60, vehiclePosition.z)
                        camera.lookAt(vehiclePosition)
                        break
                }
            } catch (error) {
                console.error('Error updating camera:', error);
            }
        }

        function setupEventListeners() {
            document.addEventListener('keydown', (e) => {
                gameState.keys[e.key] = true
                
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                    e.preventDefault()
                }
            })
            
            document.addEventListener('keyup', (e) => {
                gameState.keys[e.key] = false
                
                if (e.key === 'c' || e.key === 'C') {
                    toggleCamera()
                }
            })
            
            window.addEventListener('resize', () => {
                if (camera && renderer) {
                    camera.aspect = window.innerWidth / window.innerHeight
                    camera.updateProjectionMatrix()
                    renderer.setSize(window.innerWidth, window.innerHeight)
                }
                
                // Resize inspection renderer if active
                if (gameState.inspectionRenderer) {
                    const viewerElement = document.getElementById('vehicle3DViewer')
                    if (viewerElement) {
                        gameState.inspectionRenderer.setSize(viewerElement.clientWidth, viewerElement.clientHeight)
                    }
                }
            })
        }

        function startGameLoop() {
            setInterval(() => {
                if (!gameState.gameLoaded) return
                
                gameState.gameTime++
                updateGameTimer()
                
                // Maintain traffic density
                if (gameState.gameTime % 6 === 0 && gameState.otherVehicles.length < 12) {
                    spawnAIVehicle()
                }
                
                // Maintain pedestrian population
                if (gameState.gameTime % 10 === 0 && gameState.pedestrians.length < 6) {
                    spawnPedestrian()
                }
                
                // Update inspection specs if modal is open
                if (document.getElementById('vehicleInspectionModal').style.display !== 'none') {
                    updateInspectionSpecs()
                }
            }, 1000)
            
            setInterval(() => {
                if (!gameState.gameLoaded) return
                updateTrafficLights()
            }, 100)
        }

        function updateGameTimer() {
            const minutes = Math.floor(gameState.gameTime / 60)
            const seconds = gameState.gameTime % 60
            document.getElementById('gameTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
        }

        function updateTrafficLights() {
            gameState.trafficLights.forEach(light => {
                light.timer += 0.1
                
                // Reset all lights
                if (light.redLight) light.redLight.material.emissive.setHex(0x330000)
                if (light.yellowLight) light.yellowLight.material.emissive.setHex(0x333300)
                if (light.greenLight) light.greenLight.material.emissive.setHex(0x003300)
                
                // Traffic light timing: Red 15s, Green 15s, Yellow 3s (Indonesian standard)
                const timings = { green: 15, yellow: 3, red: 15 }
                
                switch (light.state) {
                    case 'green':
                        if (light.greenLight) light.greenLight.material.emissive.setHex(0x00ff00)
                        if (light.timer >= timings.green) {
                            light.state = 'yellow'
                            light.timer = 0
                        }
                        break
                    case 'yellow':
                        if (light.yellowLight) light.yellowLight.material.emissive.setHex(0xffff00)
                        if (light.timer >= timings.yellow) {
                            light.state = 'red'
                            light.timer = 0
                        }
                        break
                    case 'red':
                        if (light.redLight) light.redLight.material.emissive.setHex(0xff0000)
                        if (light.timer >= timings.red) {
                            light.state = 'green'
                            light.timer = 0
                        }
                        break
                }
            })
        }

        function updatePlayerMovement() {
            if (!playerVehicle || !gameState.gameLoaded) return
            
            try {
                const deltaTime = 0.016
                let acceleration = 0
                let steering = 0
                
                if (gameState.keys['w'] || gameState.keys['W'] || gameState.keys['ArrowUp']) {
                    acceleration = 1
                    if (!gameState.isEngineStarted && gameState.selectedVehicle !== 'pedestrian') {
                        startEngine()
                    }
                }
                if (gameState.keys['s'] || gameState.keys['S'] || gameState.keys['ArrowDown']) {
                    acceleration = -0.6
                }
                if (gameState.keys['a'] || gameState.keys['A'] || gameState.keys['ArrowLeft']) {
                    steering = -1
                }
                if (gameState.keys['d'] || gameState.keys['D'] || gameState.keys['ArrowRight']) {
                    steering = 1
                }
                if (gameState.keys[' ']) {
                    acceleration = -2
                }
                
                // Determine current road type and speed limit
                updateCurrentRoadType()
                let maxSpeed = gameState.currentRoadType === 'major' ? 50 : 30
                if (gameState.selectedVehicle === 'pedestrian') {
                    maxSpeed = 8
                } else if (gameState.selectedVehicle === 'motorcycle') {
                    maxSpeed = Math.min(maxSpeed, 60)
                }
                
                if (acceleration > 0) {
                    gameState.currentSpeed += 18 * deltaTime
                } else if (acceleration < 0) {
                    gameState.currentSpeed -= 30 * deltaTime
                } else {
                    gameState.currentSpeed *= 0.95
                }
                
                gameState.currentSpeed = Math.max(-25, Math.min(gameState.currentSpeed, maxSpeed))
                
                // Check violations
                checkTrafficLightCompliance()
                checkSpeedingViolation()
                checkPedestrianCrossing()
                checkWrongLaneViolation()
                checkYellowBoxViolation()
                checkRedStopBoxViolation()
                
                // 3D Vehicle Rotation
                if (Math.abs(gameState.currentSpeed) > 1) {
                    gameState.targetRotationY += steering * deltaTime * (gameState.currentSpeed / 45) * 1.8
                }
                
                // Smooth rotation interpolation
                const rotationDiff = gameState.targetRotationY - gameState.vehicleRotationY
                gameState.vehicleRotationY += rotationDiff * 0.1
                playerVehicle.rotation.y = gameState.vehicleRotationY
                
                const moveX = Math.sin(playerVehicle.rotation.y) * gameState.currentSpeed * deltaTime
                const moveZ = Math.cos(playerVehicle.rotation.y) * gameState.currentSpeed * deltaTime
                
                // Update position
                playerVehicle.position.x += moveX
                playerVehicle.position.z += moveZ
                
                // Keep player in bounds
                playerVehicle.position.x = Math.max(-120, Math.min(120, playerVehicle.position.x))
                playerVehicle.position.z = Math.max(-120, Math.min(120, playerVehicle.position.z))
                
                updateCurrentLane()
                updateSpeedDisplay()
                updateUI()
                updateQuickInspectorPanel()
            } catch (error) {
                console.error('Error updating player movement:', error);
            }
        }

        function updateCurrentRoadType() {
            const x = playerVehicle.position.x
            const z = playerVehicle.position.z
            
            // Check if on major road (4 arah utama)
            if ((Math.abs(z) < 12 && Math.abs(x) < 100) || (Math.abs(x) < 12 && Math.abs(z) < 100)) {
                gameState.currentRoadType = 'major'
                gameState.currentSpeedLimit = 50
            }
            // Check if on minor road
            else if ((Math.abs(z - 60) < 4 && Math.abs(x) < 80) || 
             (Math.abs(z + 60) < 4 && Math.abs(x) < 80) ||
             (Math.abs(x - 60) < 4 && Math.abs(z) < 80) ||
             (Math.abs(x + 60) < 4 && Math.abs(z) < 80)) {
                gameState.currentRoadType = 'minor'
                gameState.currentSpeedLimit = 30
            }
            else {
                gameState.currentRoadType = 'off-road'
                gameState.currentSpeedLimit = 20
            }
        }

        function checkTrafficLightCompliance() {
            let nearRedLight = false
            let currentLightState = 'green'
            
            gameState.trafficLights.forEach(light => {
                const distance = Math.sqrt(
                    Math.pow(playerVehicle.position.x - light.position.x, 2) + 
                    Math.pow(playerVehicle.position.z - light.position.z, 2)
                )
                
                if (distance < 40) {
                    currentLightState = light.state
                    gameState.currentTrafficLightState = light.state
                    
                    if (light.state === 'red' && distance < 30) {
                        nearRedLight = true
                        
                        if (gameState.currentSpeed > 3 && Date.now() - gameState.lastViolationTime > 5000) {
                            addViolation(VIOLATIONS.RED_LIGHT)
                            gameState.lastViolationTime = Date.now()
                        } else if (gameState.currentSpeed <= 3 && !gameState.hasStoppedAtRedLight) {
                            showMessage('‚úÖ Berhenti dengan benar di lampu merah (+75 poin)', 'success')
                            gameState.score += 75
                            gameState.hasStoppedAtRedLight = true
                        }
                    } else if (light.state === 'yellow' && gameState.currentSpeed > 35 && distance < 20) {
                        if (Date.now() - gameState.lastViolationTime > 3000) {
                            showViolation(
                                `Menerobos lampu kuning dengan kecepatan tinggi! Berbahaya!`, 
                                'minor'
                            )
                            gameState.lastViolationTime = Date.now()
                        }
                    }
                }
                
                if (distance > 40) {
                    gameState.hasStoppedAtRedLight = false
                }
            })
            
            gameState.nearTrafficLight = nearRedLight
        }

        function checkSpeedingViolation() {
            if (gameState.currentSpeed > gameState.currentSpeedLimit * 1.3) {
                if (Date.now() - gameState.lastViolationTime > 4000) {
                    addViolation(VIOLATIONS.SPEEDING)
                    gameState.lastViolationTime = Date.now()
                }
            }
        }

        function checkPedestrianCrossing() {
            let pedestrianCrossing = false
            
            gameState.pedestrians.forEach(pedestrian => {
                if (pedestrian.userData.crossing) {
                    const distance = Math.sqrt(
                        Math.pow(playerVehicle.position.x - pedestrian.position.x, 2) + 
                        Math.pow(playerVehicle.position.z - pedestrian.position.z, 2)
                    )
                    
                    if (distance < 25) {
                        pedestrianCrossing = true
                        
                        if (gameState.currentSpeed > 5 && gameState.selectedVehicle !== 'pedestrian') {
                            if (Date.now() - gameState.lastViolationTime > 5000) {
                                addViolation(VIOLATIONS.PEDESTRIAN_CROSSING)
                                gameState.lastViolationTime = Date.now()
                            }
                        }
                    }
                }
            })
            
            gameState.pedestrianCrossing = pedestrianCrossing
        }

        function checkWrongLaneViolation() {
            // Check if pedestrian is on vehicle lane or vice versa
            if (gameState.selectedVehicle === 'pedestrian' && gameState.currentLane === 'vehicle' && gameState.currentSpeed > 1) {
                if (Date.now() - gameState.lastViolationTime > 8000) {
                    showViolation(
                        `Pejalan kaki di jalur kendaraan! Pasal 131 - Gunakan trotoar!`, 
                        'minor'
                    )
                    gameState.lastViolationTime = Date.now()
                }
            } else if (gameState.selectedVehicle !== 'pedestrian' && gameState.currentLane === 'sidewalk' && gameState.currentSpeed > 1) {
                if (Date.now() - gameState.lastViolationTime > 6000) {
                    addViolation(VIOLATIONS.WRONG_LANE)
                    gameState.lastViolationTime = Date.now()
                }
            }
        }

        function checkYellowBoxViolation() {
            const x = playerVehicle.position.x
            const z = playerVehicle.position.z
            
            // Check if in Yellow Box Junction (center intersection)
            if (Math.abs(x) < 15 && Math.abs(z) < 15) {
                if (!gameState.inYellowBox) {
                    gameState.inYellowBox = true
                }
                
                // Check if stopped in Yellow Box
                if (gameState.currentSpeed < 2 && gameState.inYellowBox) {
                    if (Date.now() - gameState.lastViolationTime > 3000) {
                        addViolation(VIOLATIONS.YELLOW_BOX)
                        gameState.lastViolationTime = Date.now()
                    }
                }
            } else {
                gameState.inYellowBox = false
            }
        }

        function checkRedStopBoxViolation() {
            const x = playerVehicle.position.x
            const z = playerVehicle.position.z
            
            // Check if in Red Stop Box areas (DI BELAKANG ZEBRA CROSS)
            const inRedStopBox = (
                (Math.abs(x) < 12 && Math.abs(z - 25) < 3) ||  // North approach
                (Math.abs(x) < 12 && Math.abs(z + 25) < 3) ||  // South approach
                (Math.abs(z) < 12 && Math.abs(x - 25) < 3) ||  // East approach
                (Math.abs(z) < 12 && Math.abs(x + 25) < 3)     // West approach
            )
            
            if (inRedStopBox) {
                if (!gameState.inRedStopBox) {
                    gameState.inRedStopBox = true
                }
                
                // Check if entered Red Stop Box during red light
                if (gameState.currentTrafficLightState === 'red' && gameState.currentSpeed > 2) {
                    if (Date.now() - gameState.lastViolationTime > 2000) {
                        addViolation(VIOLATIONS.STOP_BOX)
                        gameState.lastViolationTime = Date.now()
                    }
                }
            } else {
                gameState.inRedStopBox = false
            }
        }

        function addViolation(violation) {
            gameState.violations++
            gameState.score = Math.max(0, gameState.score - (violation.fine / 3000))
            
            showViolation(
                `${violation.description} - ${violation.code} - Denda: Rp ${violation.fine.toLocaleString()}`, 
                violation.severity
            )
            
            // Update legal status
            document.getElementById('legalStatus').textContent = 'Melanggar'
            document.getElementById('legalStatus').style.color = '#ef4444'
            
            setTimeout(() => {
                document.getElementById('legalStatus').textContent = 'Patuh'
                document.getElementById('legalStatus').style.color = '#10b981'
            }, 12000)
        }

        function updateAIVehicles() {
            gameState.otherVehicles.forEach((vehicle, index) => {
                if (!vehicle.parent) {
                    gameState.otherVehicles.splice(index, 1)
                    return
                }
                
                try {
                    const userData = vehicle.userData
                    const deltaTime = 0.016
                    
                    // Check if AI vehicle should stop at red light
                    let shouldStopForLight = false
                    gameState.trafficLights.forEach(light => {
                        const distance = Math.sqrt(
                            Math.pow(vehicle.position.x - light.position.x, 2) + 
                            Math.pow(vehicle.position.z - light.position.z, 2)
                        )
                        
                        if (distance < 35 && light.state === 'red') {
                            shouldStopForLight = true
                            userData.stoppedAtLight = true
                        } else if (light.state === 'green' && userData.stoppedAtLight) {
                            userData.stoppedAtLight = false
                        }
                    })
                    
                    // Check if AI vehicle should stop for pedestrians
                    let shouldStopForPedestrian = false
                    gameState.pedestrians.forEach(pedestrian => {
                        if (pedestrian.userData.crossing) {
                            const distance = Math.sqrt(
                                Math.pow(vehicle.position.x - pedestrian.position.x, 2) + 
                                Math.pow(vehicle.position.z - pedestrian.position.z, 2)
                            )
                            
                            if (distance < 20) {
                                shouldStopForPedestrian = true
                                userData.stoppedForPedestrian = true
                            }
                        }
                    })
                    
                    if (!shouldStopForPedestrian) {
                        userData.stoppedForPedestrian = false
                    }
                    
                    // AI vehicle behavior
                    if (shouldStopForLight || shouldStopForPedestrian) {
                        userData.speed = Math.max(0, userData.speed - 35 * deltaTime)
                    } else {
                        userData.speed = Math.min(userData.targetSpeed, userData.speed + 12 * deltaTime)
                    }
                    
                    // 3D Rotation for AI vehicles
                    if (!userData.stoppedAtLight && !userData.stoppedForPedestrian && userData.speed > 1) {
                        // Smooth rotation interpolation
                        const rotationDiff = userData.targetRotationY - userData.rotationY
                        userData.rotationY += rotationDiff * 0.05
                        vehicle.rotation.y = userData.rotationY
                        
                        // Move AI vehicle
                        vehicle.position.x += userData.direction.x * userData.speed * deltaTime
                        vehicle.position.z += userData.direction.z * userData.speed * deltaTime
                    }
                    
                    // Remove if too far
                    if (Math.abs(vehicle.position.x) > 150 || Math.abs(vehicle.position.z) > 150) {
                        scene.remove(vehicle)
                        gameState.otherVehicles.splice(index, 1)
                    }
                } catch (error) {
                    console.error('Error updating AI vehicle:', error);
                }
            })
        }

        function updatePedestrians() {
            gameState.pedestrians.forEach((pedestrian, index) => {
                if (!pedestrian.parent) {
                    gameState.pedestrians.splice(index, 1)
                    return
                }
                
                try {
                    const userData = pedestrian.userData
                    const deltaTime = 0.016
                    
                    // Check if pedestrian should wait for red light (pedestrians cross when vehicles have red)
                    let canCross = false
                    gameState.trafficLights.forEach(light => {
                        const distance = Math.sqrt(
                            Math.pow(pedestrian.position.x - light.position.x, 2) + 
                            Math.pow(pedestrian.position.z - light.position.z, 2)
                        )
                        
                        if (distance < 40 && light.state === 'red') {
                            canCross = true
                        }
                    })
                    
                    // Pedestrian behavior
                    if (!userData.crossing && !userData.waitingToCross) {
                        const distanceToTarget = Math.sqrt(
                            Math.pow(pedestrian.position.x - userData.target.x, 2) + 
                            Math.pow(pedestrian.position.z - userData.target.z, 2)
                        )
                        
                        if (distanceToTarget < 45) {
                            userData.waitingToCross = true
                        }
                    }
                    
                    if (userData.waitingToCross && canCross) {
                        userData.crossing = true
                        userData.waitingToCross = false
                    }
                    
                    // Move pedestrian
                    if (userData.crossing || !userData.waitingToCross) {
                        pedestrian.position.x += userData.direction.x * userData.speed * deltaTime
                        pedestrian.position.z += userData.direction.z * userData.speed * deltaTime
                        
                        const distanceToTarget = Math.sqrt(
                            Math.pow(pedestrian.position.x - userData.target.x, 2) + 
                            Math.pow(pedestrian.position.z - userData.target.z, 2)
                        )
                        
                        if (distanceToTarget < 4) {
                            userData.crossing = false
                            // Set new random target at zebra crossings
                            const newTargets = [
                                { x: -20, z: 40 }, { x: 20, z: 40 },
                                { x: 20, z: -40 }, { x: -20, z: -40 },
                                { x: 40, z: -20 }, { x: 40, z: 20 },
                                { x: -40, z: 20 }, { x: -40, z: -20 }
                            ]
                            userData.target = newTargets[Math.floor(Math.random() * newTargets.length)]
                            
                            const dx = userData.target.x - pedestrian.position.x
                            const dz = userData.target.z - pedestrian.position.z
                            const length = Math.sqrt(dx * dx + dz * dz)
                            userData.direction = new THREE.Vector3(dx / length, 0, dz / length)
                        }
                    }
                    
                    // Remove if too far
                    if (Math.abs(pedestrian.position.x) > 150 || Math.abs(pedestrian.position.z) > 150) {
                        scene.remove(pedestrian)
                        gameState.pedestrians.splice(index, 1)
                    }
                } catch (error) {
                    console.error('Error updating pedestrian:', error);
                }
            })
        }

        function updateCurrentLane() {
            const z = playerVehicle.position.z
            const x = playerVehicle.position.x
            
            // Determine lane based on position
            if (Math.abs(z) < 15 && Math.abs(x) < 15) {
                gameState.currentLane = 'intersection'
            } else if ((Math.abs(z) < 12 && Math.abs(x) < 100) || (Math.abs(x) < 12 && Math.abs(z) < 100)) {
                gameState.currentLane = 'vehicle'
            } else if ((Math.abs(z - 60) < 4 && Math.abs(x) < 80) || 
                       (Math.abs(z + 60) < 4 && Math.abs(x) < 80) ||
                       (Math.abs(x - 60) < 4 && Math.abs(z) < 80) ||
                       (Math.abs(x + 60) < 4 && Math.abs(z) < 80)) {
                gameState.currentLane = 'vehicle'
            } else if ((Math.abs(z) >= 15 && Math.abs(z) <= 18) || (Math.abs(x) >= 15 && Math.abs(x) <= 18)) {
                gameState.currentLane = 'sidewalk'
            } else {
                gameState.currentLane = 'off-road'
            }
            
            document.getElementById('currentLane').textContent = {
                'vehicle': gameState.currentRoadType === 'major' ? 'Jalan Mayor' : 'Jalan Minor',
                'sidewalk': 'Trotoar',
                'intersection': 'Persimpangan',
                'off-road': 'Luar Jalan'
            }[gameState.currentLane]
        }

        function updateUI() {
            document.getElementById('score').textContent = Math.round(gameState.score)
            document.getElementById('violations').textContent = gameState.violations
            document.getElementById('level').textContent = gameState.level
            document.getElementById('pedestrianCount').textContent = gameState.pedestrians.length
            
            // Update traffic light status
            document.getElementById('trafficLight').textContent = {
                'red': 'üî¥ Merah',
                'yellow': 'üü° Kuning', 
                'green': 'üü¢ Hijau'
            }[gameState.currentTrafficLightState]
            
            // Update traffic density
            const density = gameState.otherVehicles.length
            let densityText = 'Rendah'
            if (density > 10) densityText = 'Padat'
            else if (density > 6) densityText = 'Sedang'
            else if (density > 3) densityText = 'Ringan'
            
            document.getElementById('trafficDensity').textContent = densityText
            
            // Update location
            const x = playerVehicle.position.x
            const z = playerVehicle.position.z
            
            let location = 'Simpang 4 Tengah Kota'
            if (Math.abs(x) > 50 || Math.abs(z) > 50) {
                location = 'Pinggiran Simpang'
            }
            
            if (gameState.currentLane === 'sidewalk') {
                location += ' - Trotoar'
            } else if (gameState.currentRoadType === 'major') {
                location += ' - Jalan Mayor'
            } else if (gameState.currentRoadType === 'minor') {
                location += ' - Jalan Minor'
            }
            
            document.getElementById('currentLocation').textContent = location
            
            // Update control info based on vehicle type
            const controlInfo = {
                'car': 'WASD / Arrow Keys + Space (Rem)',
                'motorcycle': 'WASD / Arrow Keys + Space (Rem)',
                'pedestrian': 'WASD / Arrow Keys'
            }
            document.getElementById('controlInfo').textContent = controlInfo[gameState.selectedVehicle]
            
            // Continuous scoring
            if (gameState.isEngineStarted || gameState.selectedVehicle === 'pedestrian') {
                gameState.score += 1.5
                
                // Bonus for using sidewalk as pedestrian
                if (gameState.selectedVehicle === 'pedestrian' && gameState.currentLane === 'sidewalk') {
                    gameState.score += 0.8
                }
                
                // Bonus for following speed limit
                if (gameState.currentSpeed <= gameState.currentSpeedLimit && gameState.currentSpeed > 0) {
                    gameState.score += 0.3
                }
                
                // Bonus for proper road usage
                if (gameState.currentRoadType === 'major' && gameState.currentLane === 'vehicle') {
                    gameState.score += 0.2
                }
            }
            
            // Level progression
            if (gameState.score > gameState.level * 2500) {
                gameState.level++
                showMessage(`üéâ Naik ke Level ${gameState.level}! Bonus: +750 poin`, 'success')
                gameState.score += 750
            }
        }

        function updateQuickInspectorPanel() {
            if (!gameState.inspectorMode || !playerVehicle) return
            
            // Update vehicle type
            const vehicleTypes = {
                'car': 'Mobil Sedan',
                'motorcycle': 'Sepeda Motor',
                'pedestrian': 'Pejalan Kaki'
            }
            document.getElementById('quickInspectVehicleType').textContent = vehicleTypes[gameState.selectedVehicle]
            
            // Update speed
            document.getElementById('quickInspectSpeed').textContent = `${Math.round(Math.abs(gameState.currentSpeed))} km/h`
            
            // Update direction
            const rotationDegrees = (gameState.vehicleRotationY * 180 / Math.PI) % 360
            let direction = 'Utara'
            if (rotationDegrees >= -45 && rotationDegrees < 45) direction = 'Utara'
            else if (rotationDegrees >= 45 && rotationDegrees < 135) direction = 'Timur'
            else if (rotationDegrees >= 135 || rotationDegrees < -135) direction = 'Selatan'
            else if (rotationDegrees >= -135 && rotationDegrees < -45) direction = 'Barat'
            document.getElementById('quickInspectDirection').textContent = direction
            
            // Update status
            let status = 'Normal'
            if (gameState.nearTrafficLight && gameState.currentTrafficLightState === 'red') {
                status = 'Menunggu Lampu Merah'
            } else if (gameState.currentSpeed > gameState.currentSpeedLimit) {
                status = 'Melanggar Batas Kecepatan'
            } else if (gameState.inYellowBox) {
                status = 'Di Yellow Box'
            } else if (gameState.inRedStopBox) {
                status = 'Di Red Stop Box'
            }
            document.getElementById('quickInspectStatus').textContent = status
            
            // Update rotation
            document.getElementById('quickInspectRotation').textContent = `${Math.round(rotationDegrees)}¬∞`
            
            // Update position
            document.getElementById('quickInspectPosition').textContent = 
                `${Math.round(playerVehicle.position.x)}, ${Math.round(playerVehicle.position.z)}`
        }

        function updateSpeedDisplay() {
            const speedKmh = Math.abs(gameState.currentSpeed)
            document.getElementById('speedValue').textContent = Math.round(speedKmh)
            document.getElementById('currentSpeed').textContent = `${Math.round(speedKmh)} km/h`
            document.getElementById('speedLimit').textContent = `Max: ${gameState.currentSpeedLimit}`
            
            const speedElement = document.getElementById('speedValue')
            if (speedKmh > gameState.currentSpeedLimit + 20) {
                speedElement.style.color = '#ef4444'
            } else if (speedKmh > gameState.currentSpeedLimit) {
                speedElement.style.color = '#f59e0b'
            } else {
                speedElement.style.background = 'linear-gradient(45deg, var(--secondary), var(--primary))'
                speedElement.style.webkitBackgroundClip = 'text'
                speedElement.style.webkitTextFillColor = 'transparent'
            }
        }

        // ===== UI FUNCTIONS =====
        function startEngine() {
            if (gameState.selectedVehicle === 'pedestrian') {
                showMessage('üö∂ Pejalan kaki tidak memerlukan mesin!', 'info')
                return
            }
            
            if (!gameState.isEngineStarted) {
                gameState.isEngineStarted = true
                showMessage('üîë Mesin dinyalakan! Perhatikan zebra cross di depan dan stop line di belakang.', 'success')
                gameState.score += 40
                document.getElementById('engineBtn').textContent = '‚úÖ Hidup'
                document.getElementById('engineBtn').classList.add('active')
            } else {
                showMessage('‚úÖ Mesin sudah menyala!', 'info')
            }
        }

        function useHorn() {
            if (gameState.selectedVehicle === 'pedestrian') {
                showMessage('üö∂ Pejalan kaki tidak memiliki klakson!', 'info')
                return
            }
            
            showMessage('üìØ Klakson dibunyikan! Berguna untuk memberi tahu pengguna jalan lain.', 'info')
            gameState.score += 15
        }

        function toggleLights() {
            if (gameState.selectedVehicle === 'pedestrian') {
                showMessage('üö∂ Pejalan kaki tidak memiliki lampu kendaraan!', 'info')
                return
            }
            
            gameState.lightsOn = !gameState.lightsOn
            const message = gameState.lightsOn ? 'üí° Lampu dinyalakan!' : 'üåô Lampu dimatikan!'
            showMessage(message, 'info')
            gameState.score += 8
        }

        function emergencyBrake() {
            if (gameState.selectedVehicle === 'pedestrian') {
                gameState.currentSpeed = 0
                showMessage('üõë Berhenti mendadak!', 'warning')
                return
            }
            
            gameState.currentSpeed *= 0.1
            showMessage('üö® Rem darurat diaktifkan! Penting untuk keselamatan.', 'warning')
            gameState.score += 20
        }

        function toggleCamera() {
            gameState.cameraMode = (gameState.cameraMode + 1) % 3
            const modes = ['Third Person', 'First Person', 'Overhead']
            showMessage(`üì∑ Mode kamera: ${modes[gameState.cameraMode]}`, 'info')
        }

        function toggleInspector() {
            gameState.inspectorMode = !gameState.inspectorMode
            const panel = document.getElementById('inspectorPanel')
            const btn = document.getElementById('inspectorBtn')
            
            if (gameState.inspectorMode) {
                panel.style.display = 'block'
                btn.classList.add('active')
                btn.textContent = 'üîç Tutup'
                showMessage('üîç Pemeriksa kendaraan diaktifkan! Klik "Periksa Detail 3D" untuk inspeksi lengkap.', 'info')
            } else {
                panel.style.display = 'none'
                btn.classList.remove('active')
                btn.textContent = 'üîç Periksa'
                showMessage('üîç Pemeriksa kendaraan dinonaktifkan.', 'info')
            }
        }

        function changeVehicle() {
            if (confirm('Yakin ingin mengganti kendaraan? Progress akan direset.')) {
                // Reset game state
                gameState.score = 1000
                gameState.violations = 0
                gameState.level = 1
                gameState.gameTime = 0
                gameState.gameLoaded = false
                gameState.inspectorMode = false
                gameState.vehicleRotationY = 0
                gameState.targetRotationY = 0
                
                // Hide inspector panel
                document.getElementById('inspectorPanel').style.display = 'none'
                document.getElementById('inspectorBtn').classList.remove('active')
                document.getElementById('inspectorBtn').textContent = 'üîç Periksa'
                
                // Close inspection modal if open
                document.getElementById('vehicleInspectionModal').style.display = 'none'
                
                // Remove current vehicle
                if (playerVehicle) {
                    scene.remove(playerVehicle)
                    playerVehicle = null
                }
                
                // Clear AI vehicles and pedestrians
                gameState.otherVehicles.forEach(vehicle => {
                    scene.remove(vehicle)
                })
                gameState.otherVehicles = []
                
                gameState.pedestrians.forEach(pedestrian => {
                    scene.remove(pedestrian)
                })
                gameState.pedestrians = []
                
                // Show vehicle selection
                document.getElementById('gameUI').style.display = 'none'
                document.getElementById('vehicleSelection').style.display = 'flex'
            }
        }

        function showViolation(message, severity) {
            const notification = document.getElementById('violationNotification')
            const messageDiv = document.getElementById('violationMessage')
            
            if (severity === 'minor') {
                gameState.violations++
                gameState.score = Math.max(0, gameState.score - 75)
                
                notification.className = 'violation-notification minor show'
                messageDiv.innerHTML = `
                    <div style="font-size: 12px; margin-bottom: 5px;">‚ö†Ô∏è PELANGGARAN RINGAN</div>
                    <div>${message}</div>
                    <div style="font-size: 10px; margin-top: 5px; opacity: 0.9;">Pengurangan: -75 poin</div>
                `
                
            } else if (severity === 'major') {
                gameState.violations++
                gameState.score = Math.max(0, gameState.score - 200)
                
                notification.className = 'violation-notification major show'
                messageDiv.innerHTML = `
                    <div style="font-size: 12px; margin-bottom: 5px;">üö® PELANGGARAN BERAT</div>
                    <div>${message}</div>
                    <div style="font-size: 10px; margin-top: 5px; opacity: 0.9;">Pengurangan: -200 poin</div>
                `
            }
            
            setTimeout(() => {
                notification.classList.remove('show')
            }, 6000)
        }

        function showMessage(message, type) {
            const messageEl = document.createElement('div')
            messageEl.className = `violation-notification ${type} show`
            messageEl.style.top = '140px'
            messageEl.innerHTML = `<div>${message}</div>`
            
            document.body.appendChild(messageEl)
            
            setTimeout(() => {
                messageEl.classList.remove('show')
                setTimeout(() => {
                    if (document.body.contains(messageEl)) {
                        document.body.removeChild(messageEl)
                    }
                }, 4000)
            }, 4000)
        }

        // ===== ANIMATION LOOP =====
        function animate() {
            requestAnimationFrame(animate)
            
            try {
                if (playerVehicle && gameState.gameLoaded) {
                    updatePlayerMovement()
                    updateAIVehicles()
                    updatePedestrians()
                    updateCameraPosition()
                }
                
                if (renderer && scene && camera) {
                    renderer.render(scene, camera)
                }
            } catch (error) {
                console.error('Error in animation loop:', error);
            }
        }

        // ===== START APPLICATION =====
        console.log('üõ£Ô∏è Simulasi Lalu Lintas Indonesia - Simpang 4 Tengah Kota')
        console.log('Fitur: Zebra cross di depan, stop line di belakang, inspeksi kendaraan 3D')
        console.log('Kontrol: WASD/Arrow Keys, C untuk kamera, Space untuk rem, tombol Periksa untuk inspector')
        console.log('Pilih kendaraan untuk memulai simulasi...')
    </script>
</body>
</html>

Sekarang simulasi telah diperbarui sesuai permintaan:

## üõ£Ô∏è **Perubahan Utama:**

### **1. Simpang 4 Saja:**
- **Hanya 4 jalur utama** (Utara-Selatan & Timur-Barat)
- **Jalan mayor:** 2 jalur per arah untuk jalan utama
- **Jalan minor:** 1 jalur per arah untuk akses lokal
- **Menghilangkan** jalan tambahan yang tidak perlu

### **2. Zebra Cross di Depan:**
- **Posisi zebra cross:** z: ¬±40, x: ¬±40 (DI DEPAN persimpangan)
- **Lebih jauh** dari area persimpangan untuk keamanan pejalan kaki
- **Sesuai standar** dimana pejalan kaki menyeberang sebelum masuk area kendaraan

### **3. Stop Line di Belakang:**
- **Posisi stop line:** z: ¬±20, x: ¬±20 (DI BELAKANG zebra cross)
- **Lebih dekat** ke persimpangan sebagai batas berhenti kendaraan
- **Red Stop Box** tetap di posisi z: ¬±25, x: ¬±25 (di antara stop line dan zebra cross)

### **4. Layout Tengah Kota:**
- **Persimpangan kompak** seperti di tengah kota
- **4 bangunan sudut** sebagai landmark
- **Lampu lalu lintas** di 4 sudut persimpangan
- **Trotoar** di sekeliling persimpangan

### **5. Sistem Spawning yang Disesuaikan:**
- **AI vehicles** spawn dari 4 arah utama
- **Pedestrians** spawn di zebra crossings yang baru
- **Traffic density** disesuaikan untuk area yang lebih kecil

Sekarang simulasi menampilkan simpang 4 tengah kota yang realistis dengan zebra cross di depan dan stop line di belakang sesuai standar Indonesia!